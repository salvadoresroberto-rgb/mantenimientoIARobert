<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Mantenimiento">
    <meta name="description" content="Sistema de Gesti√≥n de Mantenimiento e Inventario">
    
    <!-- Manifest -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlNpc3RlbWEgZGUgTWFudGVuaW1pZW50byIsCiAgInNob3J0X25hbWUiOiAiTWFudGVuaW1pZW50byIsCiAgImRlc2NyaXB0aW9uIjogIkdlc3Rpw7NuIGRlIG1hbnRlbmltaWVudG8gZSBpbnZlbnRhcmlvIiwKICAic3RhcnRfdXJsIjogIi4vIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjZmZmZmZmIiwKICAidGhlbWVfY29sb3IiOiAiIzI1NjNlYiIsCiAgIm9yaWVudGF0aW9uIjogImFueSIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbCwlM0NzdmcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyB2aWV3Qm94PScwIDAgMTAwIDEwMCclM0UlM0NyZWN0IHdpZHRoPScxMDAlMjcgaGVpZ2h0PScxMDAlMjcgZmlsbD0nJTIzMjU2M2ViJy8lM0UlM0N0ZXh0IHg9JzUwJTI1JyB5PSc1MCUyNScgZm9udC1zaXplPSc1MCcgdGV4dC1hbmNob3I9J21pZGRsZScgZHk9Jy4zZW0nJTNFJUYwJTlGJTk0JUE3JTNDL3RleHQlM0UlM0Mvc3ZnJTNFIiwKICAgICAgInNpemVzIjogIjE5MngxOTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIiwKICAgICAgInB1cnBvc2UiOiAiYW55IG1hc2thYmxlIgogICAgfSwKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWwsJTNDc3ZnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zycgdmlld0JveD0nMCAwIDEwMCAxMDAnJTNFJTNDcmVjdCB3aWR0aD0nMTAwJTI3IGhlaWdodD0nMTAwJTI3IGZpbGw9JyUyMzI1NjNlYicvJTNFJTNDdGV4dCB4PSc1MCUyNScgeT0nNTAlMjUnIGZvbnQtc2l6ZT0nNTAnIHRleHQtYW5jaG9yPSdtaWRkbGUnIGR5PScuM2VtJyUzRSVGMCU5RiU5NCVBNyUzQy90ZXh0JTNFJTNDL3N2ZyUzRSIsCiAgICAgICJzaXplcyI6ICI1MTJ4NTEyIiwKICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIsCiAgICAgICJwdXJwb3NlIjogImFueSBtYXNrYWJsZSIKICAgIH0KICBdCn0=">
    
    <!-- iOS Icons -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%232563eb'/%3E%3Ctext x='50%25' y='50%25' font-size='50' text-anchor='middle' dy='.3em'%3Eüîß%3C/text%3E%3C/svg%3E">
    
    <title>Sistema Mantenimiento</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:system-ui,sans-serif;background:#f3f4f6}
        .btn{padding:0.5rem 1rem;border:none;border-radius:0.375rem;cursor:pointer;font-weight:600;transition:all 0.2s}
        .btn:hover{transform:translateY(-1px);box-shadow:0 4px 6px rgba(0,0,0,0.1)}
        .bp{background:#2563eb;color:#fff}
        .bp:hover{background:#1e40af}
        .bs{background:#10b981;color:#fff}
        .bs:hover{background:#059669}
        .bg{background:#6b7280;color:#fff}
        .bg:hover{background:#4b5563}
        input,select,textarea{width:100%;padding:0.5rem;border:1px solid #d1d5db;border-radius:0.375rem;font-size:1rem;margin-bottom:0.75rem}
        input:focus,select:focus,textarea:focus{outline:none;border-color:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,0.1)}
        table{width:100%;border-collapse:collapse}
        th,td{padding:0.75rem;text-align:left}
        th{background:#f9fafb;font-weight:600}
        tr{border-bottom:1px solid #e5e7eb}
        
        /* Scrollbar personalizado */
        ::-webkit-scrollbar{width:8px;height:8px}
        ::-webkit-scrollbar-track{background:#f1f1f1;border-radius:10px}
        ::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:10px}
        ::-webkit-scrollbar-thumb:hover{background:#94a3b8}
        
        /* Animaci√≥n para timeline */
        @keyframes slideIn{
            from{opacity:0;transform:translateX(-20px)}
            to{opacity:1;transform:translateX(0)}
        }
    </style>
</head>
<body>
    <div id="root">Cargando...</div>
    
    <script type="text/babel">
        const {useState,useEffect}=React;
        
        // ==================== CONFIGURACI√ìN FIREBASE ====================
        // IMPORTANTE: Esta es una configuraci√≥n de EJEMPLO
        // Para producci√≥n, obt√©n tu propia config en: https://console.firebase.google.com
        const firebaseConfig = {
           apiKey: "AIzaSyXXXXXXXXXXXXXXXXXXXXX",                           
   	   authDomain: "tu-proyecto.firebaseapp.com",
           databaseURL: "https://tu-proyecto.firebaseio.com",
           projectId: "tu-proyecto",
           storageBucket: "tu-proyecto.appspot.com",
           messagingSenderId: "123456789012",
           appId: "1:123456789012:web:xxxxxxxxxxxxx"
          };
        let db = null;
        let syncEnabled = false;
        let realtimeListeners = {}; // Almacenar listeners activos
        
        // Generar ID √∫nico del dispositivo
        const getDeviceId = () => {
            let deviceId = localStorage.getItem('deviceId');
            if (!deviceId) {
                deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('deviceId', deviceId);
            }
            return deviceId;
        };
        
        // Detectar tipo de dispositivo
        const getDeviceInfo = () => {
            const ua = navigator.userAgent;
            let type = 'desktop';
            if (/android/i.test(ua)) type = 'android';
            else if (/iPad|iPhone|iPod/.test(ua)) type = 'ios';
            else if (/tablet/i.test(ua)) type = 'tablet';
            
            return {
                id: getDeviceId(),
                type: type,
                userAgent: ua,
                platform: navigator.platform
            };
        };
        
        // Inicializar Firebase solo si hay configuraci√≥n v√°lida
        try {
            if (firebaseConfig.databaseURL && firebaseConfig.apiKey !== "demo-key") {
                firebase.initializeApp(firebaseConfig);
                db = firebase.database();
                syncEnabled = true;
                const deviceInfo = getDeviceInfo();
                console.log('‚úÖ SINCRONIZACI√ìN MULTI-DISPOSITIVO ACTIVADA');
                console.log('üì± Dispositivo:', deviceInfo.type, '- ID:', deviceInfo.id);
                console.log('üîÑ Los cambios se sincronizar√°n en tiempo real');
                
                // Registrar dispositivo activo
                db.ref('activeDevices/' + deviceInfo.id).set({
                    ...deviceInfo,
                    lastSeen: Date.now(),
                    timestamp: new Date().toISOString()
                });
                
                // Actualizar lastSeen cada minuto
                setInterval(() => {
                    if (syncEnabled && db) {
                        db.ref('activeDevices/' + deviceInfo.id + '/lastSeen').set(Date.now());
                    }
                }, 60000);
            } else {
                console.log('‚ÑπÔ∏è MODO LOCAL - Los datos se guardan solo en este dispositivo');
                console.log('üí° Para usar en m√∫ltiples dispositivos simult√°neamente:');
                console.log('   1. Ve a https://console.firebase.google.com');
                console.log('   2. Crea un proyecto gratuito');
                console.log('   3. Habilita Realtime Database');
                console.log('   4. Copia la configuraci√≥n en este archivo');
            }
        } catch (error) {
            console.warn('‚ö†Ô∏è Firebase no disponible, usando modo local:', error.message);
            syncEnabled = false;
        }
        
        // ==================== SISTEMA DE SINCRONIZACI√ìN EN TIEMPO REAL ====================
        
        // Sincronizar datos a la nube
        const syncToCloud = (key, data) => {
            if (!syncEnabled || !db) {
                // Solo localStorage
                localStorage.setItem(key, JSON.stringify(data));
                return Promise.resolve();
            }
            
            // Guardar en localStorage (backup local inmediato)
            localStorage.setItem(key, JSON.stringify(data));
            
            // Guardar en Firebase con metadata completa
            return db.ref(key).set({
                data: data,
                timestamp: Date.now(),
                version: '2.0',
                deviceId: getDeviceId(),
                deviceType: getDeviceInfo().type,
                lastUpdate: new Date().toISOString()
            }).then(() => {
                console.log(`‚úÖ Sincronizado: ${key}`);
            }).catch(error => {
                console.error(`‚ùå Error sincronizando ${key}:`, error);
                // Continuar aunque falle la sync (datos est√°n en localStorage)
            });
        };
        
        const loadFromCloud = (key, fallback = null) => {
            return new Promise((resolve) => {
                // Primero cargar desde localStorage (inmediato)
                const localData = localStorage.getItem(key);
                
                if (!syncEnabled || !db) {
                    // Modo local
                    resolve(localData ? JSON.parse(localData) : fallback);
                    return;
                }
                
                // Intentar cargar desde Firebase
                db.ref(key).once('value').then(snapshot => {
                    const cloudData = snapshot.val();
                    
                    if (cloudData && cloudData.data) {
                        // Comparar timestamps
                        const localTimestamp = localData ? JSON.parse(localData).timestamp : 0;
                        const cloudTimestamp = cloudData.timestamp || 0;
                        
                        if (cloudTimestamp > localTimestamp) {
                            // Nube m√°s reciente
                            localStorage.setItem(key, JSON.stringify(cloudData.data));
                            resolve(cloudData.data);
                        } else {
                            // Local m√°s reciente o igual
                            resolve(localData ? JSON.parse(localData) : fallback);
                        }
                    } else {
                        // No hay datos en nube
                        resolve(localData ? JSON.parse(localData) : fallback);
                    }
                }).catch(error => {
                    console.warn('Error cargando desde nube:', error);
                    // Fallback a local
                    resolve(localData ? JSON.parse(localData) : fallback);
                });
            });
        };
        
        // ==================== SINCRONIZACI√ìN EN TIEMPO REAL ====================
        
        // Escuchar cambios en tiempo real desde otros dispositivos
        const listenToRealtimeChanges = (key, callback) => {
            if (!syncEnabled || !db) {
                // Sin sincronizaci√≥n en tiempo real
                return () => {}; // Retornar funci√≥n vac√≠a para cleanup
            }
            
            // Si ya hay un listener, removerlo primero
            if (realtimeListeners[key]) {
                db.ref(key).off('value', realtimeListeners[key]);
            }
            
            // Crear nuevo listener
            const listener = db.ref(key).on('value', (snapshot) => {
                const cloudData = snapshot.val();
                
                if (cloudData && cloudData.data) {
                    // Verificar que no sea cambio del mismo dispositivo
                    if (cloudData.deviceId !== getDeviceId()) {
                        console.log(`üîÑ Actualizaci√≥n recibida de otro dispositivo (${cloudData.deviceType}):`, key);
                        
                        // Actualizar localStorage
                        localStorage.setItem(key, JSON.stringify(cloudData.data));
                        
                        // Ejecutar callback para actualizar UI
                        if (callback) {
                            callback(cloudData.data);
                        }
                    }
                }
            });
            
            // Guardar referencia del listener
            realtimeListeners[key] = listener;
            
            // Retornar funci√≥n de cleanup
            return () => {
                db.ref(key).off('value', listener);
                delete realtimeListeners[key];
            };
        };
        
        // Limpiar todos los listeners al cerrar
        window.addEventListener('beforeunload', () => {
            Object.keys(realtimeListeners).forEach(key => {
                if (db) {
                    db.ref(key).off('value', realtimeListeners[key]);
                }
            });
            
            // Actualizar √∫ltima vez visto del dispositivo
            if (syncEnabled && db) {
                const deviceId = getDeviceId();
                db.ref('activeDevices/' + deviceId + '/lastSeen').set(Date.now());
            }
        });
        
        // ==================== PWA: SERVICE WORKER ====================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Service Worker inline
                const swCode = `
                    const CACHE_NAME = 'mantenimiento-v1';
                    const urlsToCache = ['./', 'index.html'];
                    
                    self.addEventListener('install', event => {
                        event.waitUntil(
                            caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache))
                        );
                    });
                    
                    self.addEventListener('fetch', event => {
                        event.respondWith(
                            caches.match(event.request).then(response => {
                                return response || fetch(event.request);
                            })
                        );
                    });
                `;
                
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl).then(registration => {
                    console.log('‚úÖ PWA instalada correctamente');
                }).catch(error => {
                    console.log('‚ÑπÔ∏è PWA no disponible:', error);
                });
            });
        }
        
        // ==================== COMPONENTE APP ====================
        function App(){
            const[u,setU]=useState(null);
            const[us,setUs]=useState([]);
            const[os,setOs]=useState([]);
            const[ps,setPs]=useState({});
            const[inv,setInv]=useState([]); // Inventario de repuestos
            const[v,setV]=useState('d');
            const[m,setM]=useState(null);
            const[mo,setMo]=useState(false);
            const[syncStatus,setSyncStatus]=useState(syncEnabled?'üåê Sincronizando...':'üíæ Modo Local');
            const[installPrompt,setInstallPrompt]=useState(null);
            
            // Detectar evento de instalaci√≥n PWA
            useEffect(()=>{
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    setInstallPrompt(e);
                });
            },[]);
            
            // Cargar datos (con sincronizaci√≥n en nube si est√° disponible)
            useEffect(()=>{
                const loadData = async () => {
                    setSyncStatus(syncEnabled?'üåê Cargando...':'üíæ Modo Local');
                    
                    // Cargar usuarios
                    const userData = await loadFromCloud('u');
                    if(userData) {
                        setUs(userData);
                    } else {
                        const a={id:1,username:'admin',password:'admin123',name:'Admin',role:'supervisor',email:'a@m.com',tel:'600000000'};
                        await syncToCloud('u', [a]);
                        setUs([a]);
                    }
                    
                    // Cargar √≥rdenes
                    const ordersData = await loadFromCloud('o');
                    if(ordersData) setOs(ordersData);
                    
                    // Cargar permisos
                    const permsData = await loadFromCloud('p');
                    if(permsData) {
                        setPs(permsData);
                    } else {
                        const dp={
                            supervisor:{co:1,eo:1,do:1,cu:1,eu:1,du:1,ei:1,ar:1,cr:1,er:1,pdf:1,imp:1,arch:1,modpdf:1,ia:1},
                            creador:{co:1,eo:1,do:0,cu:0,eu:0,du:0,ei:1,ar:1,cr:1,er:0,pdf:0,imp:0,arch:0,modpdf:0,ia:1},
                            mecanico:{co:0,eo:0,do:0,cu:0,eu:0,du:0,ei:0,ar:0,cr:1,er:0,pdf:0,imp:0,arch:0,modpdf:0,ia:1}
                        };
                        await syncToCloud('p', dp);
                        setPs(dp);
                    }
                    
                    // Cargar inventario
                    const invData = await loadFromCloud('inv');
                    if(invData) setInv(invData);
                    
                    setSyncStatus(syncEnabled?'‚úÖ Sincronizado':'üíæ Modo Local');
                };
                
                loadData();
            },[]);
            
            // ==================== SINCRONIZACI√ìN EN TIEMPO REAL ====================
            // Escuchar cambios de otros dispositivos
            useEffect(() => {
                if (!syncEnabled) return;
                
                console.log('üîÑ Activando sincronizaci√≥n en tiempo real...');
                
                // Listener para usuarios
                const cleanupUsers = listenToRealtimeChanges('u', (data) => {
                    setUs(data);
                    console.log('üë• Usuarios actualizados desde otro dispositivo');
                });
                
                // Listener para √≥rdenes
                const cleanupOrders = listenToRealtimeChanges('o', (data) => {
                    setOs(data);
                    console.log('üìã √ìrdenes actualizadas desde otro dispositivo');
                });
                
                // Listener para permisos
                const cleanupPerms = listenToRealtimeChanges('p', (data) => {
                    setPs(data);
                    console.log('‚öôÔ∏è Permisos actualizados desde otro dispositivo');
                });
                
                // Listener para inventario
                const cleanupInv = listenToRealtimeChanges('inv', (data) => {
                    setInv(data);
                    console.log('üì¶ Inventario actualizado desde otro dispositivo');
                });
                
                // Cleanup al desmontar
                return () => {
                    cleanupUsers();
                    cleanupOrders();
                    cleanupPerms();
                    cleanupInv();
                };
            }, [syncEnabled]);
            
            // Funciones de guardado con sincronizaci√≥n en nube
            const saveU=(d)=>{syncToCloud('u',d);setUs(d);setSyncStatus(syncEnabled?'‚úÖ Sincronizado':'üíæ Local')};
            const saveInv=(d)=>{syncToCloud('inv',d);setInv(d);setSyncStatus(syncEnabled?'‚úÖ Sincronizado':'üíæ Local')};
            
            // Funci√≥n mejorada que descuenta repuestos autom√°ticamente
            const saveO=(d,ordenAnterior=null)=>{
                // Si se est√° cerrando una OT (cambiando a 'cerrada')
                if(ordenAnterior){
                    const ordenNueva=d.find(o=>o.id===ordenAnterior.id);
                    
                    // Si cambi√≥ de estado a 'cerrada' y tiene repuestos
                    if(ordenNueva&&ordenNueva.es==='cerrada'&&ordenAnterior.es!=='cerrada'&&ordenNueva.rp?.length>0){
                        // Descontar repuestos del inventario
                        const nuevoInv=inv.map(item=>{
                            // Buscar si este repuesto fue usado en la OT
                            const repuestoUsado=ordenNueva.rp.find(r=>
                                r.codigo===item.codigo||
                                r.nom.toLowerCase()===item.nombre.toLowerCase()
                            );
                            
                            if(repuestoUsado){
                                const nuevaCantidad=Math.max(0,item.cantidad-repuestoUsado.cant);
                                console.log(`üì¶ Descontando: ${item.nombre} | Antes: ${item.cantidad} | Usado: ${repuestoUsado.cant} | Despu√©s: ${nuevaCantidad}`);
                                return {...item,cantidad:nuevaCantidad};
                            }
                            return item;
                        });
                        
                        // Actualizar inventario
                        saveInv(nuevoInv);
                        
                        // Mostrar notificaci√≥n
                        const repuestosDescargados=ordenNueva.rp.map(r=>`${r.nom} (${r.cant})`).join(', ');
                        alert(`‚úÖ OT cerrada\nüì¶ Repuestos descargados del inventario:\n${repuestosDescargados}`);
                    }
                }
                
                syncToCloud('o',d);
                setOs(d);
                setSyncStatus(syncEnabled?'‚úÖ Sincronizado':'üíæ Local');
            };
            
            const saveP=(d)=>{syncToCloud('p',d);setPs(d);setSyncStatus(syncEnabled?'‚úÖ Sincronizado':'üíæ Local')};
            const hp=(p)=>u.role==='supervisor'||ps[u.role]?.[p]||false;
            
            // Funci√≥n para instalar PWA
            const installPWA = () => {
                if(installPrompt){
                    installPrompt.prompt();
                    installPrompt.userChoice.then((choice)=>{
                        if(choice.outcome==='accepted'){
                            alert('‚úÖ App instalada! Ahora puedes usarla desde tu pantalla de inicio.');
                        }
                        setInstallPrompt(null);
                    });
                }
            };
            
            if(!u)return <Login us={us} onLogin={setU}/>;
            
            return(<div>
                {/* Barra superior con estado de sincronizaci√≥n */}
                <div style={{background:'#2563eb',color:'#fff',padding:'1rem',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                    <div style={{display:'flex',alignItems:'center',gap:'1rem'}}>
                        {u.role==='supervisor'&&<button onClick={()=>setMo(!mo)} style={{background:'#1e40af',border:'none',color:'#fff',padding:'0.5rem 1rem',borderRadius:'0.375rem',cursor:'pointer'}}>‚ò∞</button>}
                        <div><h1 style={{fontSize:'1.25rem'}}>üîß Mantenimiento</h1><p style={{fontSize:'0.875rem',opacity:0.9}}>{u.name}</p></div>
                    </div>
                    <div style={{display:'flex',alignItems:'center',gap:'0.5rem'}}>
                        {/* Indicador de sincronizaci√≥n mejorado */}
                        <span 
                            style={{
                                fontSize:'0.75rem',
                                padding:'0.375rem 0.75rem',
                                background:syncEnabled?'rgba(16,185,129,0.2)':'rgba(107,114,128,0.2)',
                                borderRadius:'999px',
                                display:'flex',
                                alignItems:'center',
                                gap:'0.5rem',
                                border:syncEnabled?'1px solid rgba(16,185,129,0.4)':'1px solid rgba(107,114,128,0.4)',
                                color:syncEnabled?'#065f46':'#374151',
                                fontWeight:'600'
                            }}
                            title={syncEnabled?'Sincronizaci√≥n multi-dispositivo activa. Los cambios se ver√°n en todos los dispositivos en tiempo real.':'Modo local. Para usar en m√∫ltiples dispositivos, configura Firebase.'}
                        >
                            {syncStatus}
                            {syncEnabled&&<span style={{fontSize:'0.6rem',background:'rgba(16,185,129,0.3)',padding:'0.125rem 0.375rem',borderRadius:'999px'}}>TIEMPO REAL</span>}
                        </span>
                        
                        {/* Bot√≥n instalar PWA */}
                        {installPrompt&&<button onClick={installPWA} style={{fontSize:'0.875rem',padding:'0.5rem 0.75rem',background:'#10b981',border:'none',color:'#fff',borderRadius:'0.375rem',cursor:'pointer',fontWeight:'600'}}>
                            üì± Instalar App
                        </button>}
                        
                        <button onClick={()=>setU(null)} className="btn bg">Salir</button>
                    </div>
                </div>
                {mo&&u.role==='supervisor'&&<div style={{position:'absolute',top:'70px',left:'1rem',background:'#fff',borderRadius:'0.5rem',boxShadow:'0 4px 6px rgba(0,0,0,0.1)',zIndex:100,minWidth:'250px'}}>
                    {[{l:'üë• Crear Usuario',a:()=>{setM({t:'u'});setMo(false)}},{l:'üìã Usuarios',a:()=>{setV('u');setMo(false)}},{l:'‚öôÔ∏è Permisos',a:()=>{setV('p');setMo(false)}}].map((i,x)=>
                        <button key={x} onClick={i.a} style={{display:'block',width:'100%',textAlign:'left',padding:'0.75rem 1rem',border:'none',background:'#fff',cursor:'pointer',borderBottom:x<2?'1px solid #e5e7eb':'none'}}>{i.l}</button>
                    )}
                </div>}
                <nav style={{background:'#fff',boxShadow:'0 1px 3px rgba(0,0,0,0.1)',display:'flex',gap:'1rem',padding:'0 1rem'}}>
                    <button onClick={()=>setV('d')} style={{padding:'0.75rem 1rem',border:'none',borderBottom:v==='d'?'2px solid #2563eb':'2px solid transparent',background:'none',color:v==='d'?'#2563eb':'#6b7280',cursor:'pointer',fontWeight:v==='d'?'600':'normal'}}>üìä Dashboard</button>
                    <button onClick={()=>setV('inv')} style={{padding:'0.75rem 1rem',border:'none',borderBottom:v==='inv'?'2px solid #2563eb':'2px solid transparent',background:'none',color:v==='inv'?'#2563eb':'#6b7280',cursor:'pointer',fontWeight:v==='inv'?'600':'normal'}}>üì¶ Inventario</button>
                    <button onClick={()=>setV('u')} style={{padding:'0.75rem 1rem',border:'none',borderBottom:v==='u'?'2px solid #2563eb':'2px solid transparent',background:'none',color:v==='u'?'#2563eb':'#6b7280',cursor:'pointer',fontWeight:v==='u'?'600':'normal'}}>üë• Usuarios</button>
                    {hp('arch')&&<button onClick={()=>setV('arch')} style={{padding:'0.75rem 1rem',border:'none',borderBottom:v==='arch'?'2px solid #2563eb':'2px solid transparent',background:'none',color:v==='arch'?'#2563eb':'#6b7280',cursor:'pointer',fontWeight:v==='arch'?'600':'normal'}}>üìÅ Archivo OTs</button>}
                    {u.role==='supervisor'&&<button onClick={()=>setV('p')} style={{padding:'0.75rem 1rem',border:'none',borderBottom:v==='p'?'2px solid #2563eb':'2px solid transparent',background:'none',color:v==='p'?'#2563eb':'#6b7280',cursor:'pointer',fontWeight:v==='p'?'600':'normal'}}>‚öôÔ∏è Permisos</button>}
                </nav>
                <main style={{padding:'1rem'}}>
                    {v==='d'&&<Dash u={u} us={us} os={os} saveO={saveO} setM={setM} hp={hp}/>}
                    {v==='inv'&&<Inventario inv={inv} saveInv={saveInv} u={u} hp={hp}/>}
                    {v==='u'&&<Users us={us} saveU={saveU} setM={setM} hp={hp}/>}
                    {v==='arch'&&hp('arch')&&<ArchivoOTs os={os} us={us} setM={setM} hp={hp}/>}
                    {v==='p'&&u.role==='supervisor'&&<Perms ps={ps} saveP={saveP}/>}
                </main>
                {m&&<Modal m={m} setM={setM} us={us} saveU={saveU} os={os} saveO={saveO} u={u} hp={hp} inv={inv}/>}
            </div>);
        }
        
        function Login({us,onLogin}){
            const[un,setUn]=useState('');
            const[pw,setPw]=useState('');
            const[recordar,setRecordar]=useState(false);
            
            useEffect(()=>{
                const saved=localStorage.getItem('recordarLogin');
                if(saved){
                    const data=JSON.parse(saved);
                    setUn(data.username);
                    setPw(data.password);
                    setRecordar(true);
                }
            },[]);
            
            const handleLogin=()=>{
                const f=us.find(x=>x.username===un&&x.password===pw);
                if(f){
                    if(recordar){
                        localStorage.setItem('recordarLogin',JSON.stringify({username:un,password:pw}));
                    }else{
                        localStorage.removeItem('recordarLogin');
                    }
                    onLogin(f);
                }else{
                    alert('Usuario o contrase√±a incorrectos');
                }
            };
            
            return(<div style={{minHeight:'100vh',display:'flex',alignItems:'center',justifyContent:'center',background:'linear-gradient(135deg,#2563eb,#1e40af)',padding:'1rem'}}>
                <div style={{background:'#fff',borderRadius:'0.5rem',padding:'2rem',width:'100%',maxWidth:'400px'}}>
                    <h1 style={{textAlign:'center',fontSize:'1.5rem',fontWeight:'bold',marginBottom:'1.5rem'}}>üîß Mantenimiento</h1>
                    <input type="text" placeholder="Usuario" value={un} onChange={e=>setUn(e.target.value)}/>
                    <input type="password" placeholder="Contrase√±a" value={pw} onChange={e=>setPw(e.target.value)} onKeyPress={e=>e.key==='Enter'&&handleLogin()}/>
                    
                    <label style={{display:'flex',alignItems:'center',gap:'0.5rem',marginBottom:'1rem',cursor:'pointer',fontSize:'0.875rem',color:'#374151'}}>
                        <input type="checkbox" checked={recordar} onChange={e=>setRecordar(e.target.checked)} style={{width:'18px',height:'18px',cursor:'pointer',marginBottom:0}}/>
                        <span>Recordar mi contrase√±a</span>
                    </label>
                    
                    <button onClick={handleLogin} className="btn bp" style={{width:'100%'}}>Entrar</button>
                    <div style={{marginTop:'1rem',padding:'0.75rem',background:'#dbeafe',borderRadius:'0.375rem',fontSize:'0.875rem'}}><strong>Usuario:</strong> admin<br/><strong>Pass:</strong> admin123</div>
                </div>
            </div>);
        }
        
        function Dash({u,us,os,saveO,setM,hp}){
            const[viewMode,setViewMode]=useState('kanban'); // 'kanban' o 'eisenhower'
            const my=os.filter(o=>o.aa===u.name||u.role==='supervisor'||u.role==='creador');
            const st={c:my.filter(o=>o.es==='creada').length,h:my.filter(o=>o.es==='haciendo').length,he:my.filter(o=>o.es==='hecha').length,re:my.filter(o=>o.es==='registrada').length,ce:my.filter(o=>o.es==='cerrada').length};
            const exp=()=>{
                const wb=XLSX.utils.book_new();
                
                // HOJA 1: √ìrdenes de Trabajo
                const calcTime=(o)=>{if(!o.in||!o.fi)return 'N/A';const diff=new Date(o.fi)-new Date(o.in);return(diff/(1000*60*60)).toFixed(2)};
                const getRepuestos=(o)=>o.rp?.map(r=>`${r.nom}(${r.cant})`).join(', ')||'Sin repuestos';
                const ordersData=[
                    ['N¬∫ OT','Fecha Inicio','Deadline','Mec√°nico','Encabezado','Acciones Realizadas','Repuestos','Tiempo (hrs)','Estado'],
                    ...os.map(o=>[
                        o.n,
                        o.in?new Date(o.in).toLocaleString('es-ES'):'N/A',
                        o.dl?new Date(o.dl).toLocaleString('es-ES'):'N/A',
                        o.aa,
                        o.tr,
                        o.trab||'N/A',
                        getRepuestos(o),
                        calcTime(o),
                        o.es
                    ])
                ];
                const ws1=XLSX.utils.aoa_to_sheet(ordersData);
                ws1['!cols']=[{wch:12},{wch:18},{wch:18},{wch:15},{wch:35},{wch:35},{wch:25},{wch:12},{wch:12}];
                XLSX.utils.book_append_sheet(wb,ws1,'√ìrdenes de Trabajo');
                
                // HOJA 2: Estad√≠sticas y Gr√°ficos
                const completadas=os.filter(o=>['hecha','registrada','cerrada'].includes(o.es));
                const tiempos=completadas.filter(o=>o.in&&o.fi).map(o=>(new Date(o.fi)-new Date(o.in))/(1000*60*60));
                const tiempoPromedio=tiempos.length>0?(tiempos.reduce((a,b)=>a+b,0)/tiempos.length).toFixed(2):'0';
                const aTiempo=completadas.filter(o=>o.dl&&o.fi&&new Date(o.fi)<=new Date(o.dl)).length;
                const fueraDePlazo=completadas.filter(o=>o.dl&&o.fi&&new Date(o.fi)>new Date(o.dl)).length;
                const efectividad=completadas.length>0?((aTiempo/(aTiempo+fueraDePlazo))*100).toFixed(2):'0';
                
                const statsData=[
                    ['üìä DASHBOARD DE ESTAD√çSTICAS',''],
                    [''],
                    ['RESUMEN GENERAL','VALOR'],
                    ['Total de √≥rdenes',os.length],
                    ['√ìrdenes creadas',st.c],
                    ['√ìrdenes haciendo',st.h],
                    ['√ìrdenes hechas',st.he],
                    ['√ìrdenes registradas',st.re],
                    ['√ìrdenes cerradas',st.ce],
                    [''],
                    ['M√âTRICAS DE RENDIMIENTO',''],
                    ['Tiempo promedio (hrs)',tiempoPromedio],
                    ['Efectividad general (%)',efectividad],
                    ['√ìrdenes a tiempo',aTiempo],
                    ['√ìrdenes fuera de plazo',fueraDePlazo],
                    [''],
                    [''],
                    ['üìä DATOS PARA GR√ÅFICO: DISTRIBUCI√ìN POR ESTADO',''],
                    ['Estado','Cantidad','Porcentaje'],
                    ['Creadas',st.c,os.length>0?((st.c/os.length)*100).toFixed(1)+'%':'0%'],
                    ['En Progreso',st.h,os.length>0?((st.h/os.length)*100).toFixed(1)+'%':'0%'],
                    ['Completadas',st.co,os.length>0?((st.co/os.length)*100).toFixed(1)+'%':'0%'],
                    [''],
                    [''],
                    ['üìä DATOS PARA GR√ÅFICO: CUMPLIMIENTO DE PLAZOS',''],
                    ['Categor√≠a','Cantidad','Porcentaje'],
                    ['A Tiempo',aTiempo,(aTiempo+fueraDePlazo)>0?((aTiempo/(aTiempo+fueraDePlazo))*100).toFixed(1)+'%':'0%'],
                    ['Fuera de Plazo',fueraDePlazo,(aTiempo+fueraDePlazo)>0?((fueraDePlazo/(aTiempo+fueraDePlazo))*100).toFixed(1)+'%':'0%'],
                    [''],
                    [''],
                    ['üìä DATOS PARA GR√ÅFICO: DISTRIBUCI√ìN DE TIEMPOS',''],
                    ['Orden','Tiempo (hrs)'],
                    ...tiempos.map((t,i)=>[`Orden ${i+1}`,parseFloat(t.toFixed(2))])
                ];
                const ws2=XLSX.utils.aoa_to_sheet(statsData);
                ws2['!cols']=[{wch:35},{wch:18},{wch:18}];
                
                // Agregar colores a los encabezados (simulado con nota)
                if(!ws2['A1'].c) ws2['A1'].c = [];
                ws2['A1'].c.push({a:'Sistema',t:'Crear gr√°ficos usando estos datos: Insertar > Gr√°fico en Excel'});
                
                XLSX.utils.book_append_sheet(wb,ws2,'Estad√≠sticas y Gr√°ficos');
                
                // HOJA 3: Rendimiento por Mec√°nico
                const mecanicos=[...new Set(os.map(o=>o.aa))];
                const rendData=[
                    ['üìä AN√ÅLISIS POR MEC√ÅNICO','','',''],
                    [''],
                    ['Mec√°nico','√ìrdenes Completadas','Tiempo Promedio (hrs)','Efectividad (%)']
                ];
                
                const mecanicoStats=[];
                mecanicos.forEach(mec=>{
                    const ordsMec=os.filter(o=>o.aa===mec);
                    const compMec=ordsMec.filter(o=>o.es==='completada');
                    const tiemposMec=compMec.filter(o=>o.in&&o.fi).map(o=>(new Date(o.fi)-new Date(o.in))/(1000*60*60));
                    const promMec=tiemposMec.length>0?parseFloat((tiemposMec.reduce((a,b)=>a+b,0)/tiemposMec.length).toFixed(2)):0;
                    const aTiempoMec=compMec.filter(o=>o.dl&&o.fi&&new Date(o.fi)<=new Date(o.dl)).length;
                    const totalConDL=compMec.filter(o=>o.dl&&o.fi).length;
                    const efectMec=totalConDL>0?parseFloat(((aTiempoMec/totalConDL)*100).toFixed(2)):0;
                    rendData.push([mec,compMec.length,promMec,efectMec]);
                    mecanicoStats.push({mec,comp:compMec.length,prom:promMec,efect:efectMec});
                });
                
                rendData.push(['']);
                rendData.push(['']);
                rendData.push(['üìä DATOS PARA GR√ÅFICO: √ìRDENES COMPLETADAS','']);
                rendData.push(['Mec√°nico','Cantidad']);
                mecanicoStats.forEach(m=>rendData.push([m.mec,m.comp]));
                
                rendData.push(['']);
                rendData.push(['']);
                rendData.push(['üìä DATOS PARA GR√ÅFICO: TIEMPO PROMEDIO','']);
                rendData.push(['Mec√°nico','Horas']);
                mecanicoStats.forEach(m=>rendData.push([m.mec,m.prom]));
                
                rendData.push(['']);
                rendData.push(['']);
                rendData.push(['üìä DATOS PARA GR√ÅFICO: EFECTIVIDAD','']);
                rendData.push(['Mec√°nico','Porcentaje']);
                mecanicoStats.forEach(m=>rendData.push([m.mec,m.efect]));
                
                const ws3=XLSX.utils.aoa_to_sheet(rendData);
                ws3['!cols']=[{wch:25},{wch:22},{wch:25},{wch:18}];
                
                XLSX.utils.book_append_sheet(wb,ws3,'Rendimiento por Mec√°nico');
                
                XLSX.writeFile(wb,'analisis_mantenimiento.xlsx');
            };
            
            const importarOTs=()=>{
                if(!hp('co'))return alert('No tienes permiso para crear OTs');
                
                const input=document.createElement('input');
                input.type='file';
                input.accept='.xlsx,.xls,.csv';
                input.onchange=(e)=>{
                    const file=e.target.files[0];
                    if(!file)return;
                    
                    const reader=new FileReader();
                    reader.onload=(evt)=>{
                        try{
                            const data=new Uint8Array(evt.target.result);
                            const workbook=XLSX.read(data,{type:'array'});
                            const firstSheet=workbook.Sheets[workbook.SheetNames[0]];
                            const jsonData=XLSX.utils.sheet_to_json(firstSheet,{header:1});
                            
                            // Buscar fila de encabezados
                            let headerRow=-1;
                            for(let i=0;i<Math.min(10,jsonData.length);i++){
                                const row=jsonData[i];
                                if(row.some(cell=>cell&&(cell.toString().toLowerCase().includes('trabajo')||cell.toString().toLowerCase().includes('descripci√≥n')||cell.toString().toLowerCase().includes('descripcion')))){
                                    headerRow=i;
                                    break;
                                }
                            }
                            
                            if(headerRow===-1){
                                alert('‚ùå No se encontraron encabezados v√°lidos.\n\nEl archivo debe tener columnas:\n- Trabajo (obligatorio)\n- Tipo (correctivo/preventivo/predictivo)\n- Asignado (nombre del mec√°nico)\n- Deadline (fecha)\n\nPuedes usar la plantilla descargada.');
                                return;
                            }
                            
                            const headers=jsonData[headerRow].map(h=>h?h.toString().toLowerCase().trim():'');
                            const dataRows=jsonData.slice(headerRow+1);
                            
                            // Mapear columnas
                            const colMap={
                                trabajo:headers.findIndex(h=>h.includes('trabajo')||h.includes('descripci√≥n')||h.includes('descripcion')),
                                tipo:headers.findIndex(h=>h.includes('tipo')),
                                asignado:headers.findIndex(h=>h.includes('asignado')||h.includes('mec√°nico')||h.includes('mecanico')),
                                deadline:headers.findIndex(h=>h.includes('deadline')||h.includes('fecha l√≠mite')||h.includes('fecha limite')||h.includes('vencimiento')),
                                observaciones:headers.findIndex(h=>h.includes('observaciones')||h.includes('notas'))
                            };
                            
                            // Validar columnas m√≠nimas
                            if(colMap.trabajo===-1){
                                alert('‚ùå Falta columna requerida: Trabajo/Descripci√≥n');
                                return;
                            }
                            
                            // Procesar filas
                            const nuevasOTs=[];
                            let procesados=0;
                            let errores=0;
                            const erroresDetalle=[];
                            
                            dataRows.forEach((row,idx)=>{
                                if(!row||row.length===0||!row[colMap.trabajo])return; // Saltar filas vac√≠as
                                
                                try{
                                    const trabajo=row[colMap.trabajo]?.toString().trim();
                                    if(!trabajo||trabajo.length<5){
                                        erroresDetalle.push(`Fila ${headerRow+idx+2}: Descripci√≥n muy corta o vac√≠a`);
                                        errores++;
                                        return;
                                    }
                                    
                                    // Tipo de mantenimiento
                                    let tipo='correctivo';
                                    if(colMap.tipo!==-1&&row[colMap.tipo]){
                                        const tipoStr=row[colMap.tipo].toString().toLowerCase().trim();
                                        if(tipoStr.includes('prevent'))tipo='preventivo';
                                        else if(tipoStr.includes('predict'))tipo='predictivo';
                                    }
                                    
                                    // Asignado
                                    let asignado=u.name; // Por defecto el usuario actual
                                    if(colMap.asignado!==-1&&row[colMap.asignado]){
                                        const asignadoStr=row[colMap.asignado].toString().trim();
                                        // Verificar que el usuario existe
                                        const usuarioExiste=us.find(usuario=>usuario.name.toLowerCase()===asignadoStr.toLowerCase());
                                        if(usuarioExiste){
                                            asignado=usuarioExiste.name;
                                        }else{
                                            erroresDetalle.push(`Fila ${headerRow+idx+2}: Usuario "${asignadoStr}" no encontrado, asignado a ${u.name}`);
                                        }
                                    }
                                    
                                    // Deadline
                                    let deadline=null;
                                    if(colMap.deadline!==-1&&row[colMap.deadline]){
                                        try{
                                            const dlValue=row[colMap.deadline];
                                            let fecha;
                                            
                                            // Si es n√∫mero (fecha de Excel)
                                            if(typeof dlValue==='number'){
                                                // Excel guarda fechas como d√≠as desde 1900-01-01
                                                fecha=new Date((dlValue-25569)*86400*1000);
                                            }else{
                                                // Intentar parsear como string
                                                fecha=new Date(dlValue);
                                            }
                                            
                                            if(!isNaN(fecha.getTime())){
                                                deadline=fecha.toISOString();
                                            }
                                        }catch(e){
                                            erroresDetalle.push(`Fila ${headerRow+idx+2}: Fecha inv√°lida`);
                                        }
                                    }
                                    
                                    // Observaciones
                                    let observaciones='';
                                    if(colMap.observaciones!==-1&&row[colMap.observaciones]){
                                        observaciones=row[colMap.observaciones].toString().trim();
                                    }
                                    
                                    // Crear OT
                                    const nuevaOT={
                                        id:Date.now()+idx,
                                        n:`OT-${String(os.length+nuevasOTs.length+1).padStart(4,'0')}`,
                                        ti:tipo,
                                        tr:trabajo,
                                        aa:asignado,
                                        es:'creada',
                                        cr:new Date().toISOString(),
                                        dl:deadline,
                                        ob:observaciones,
                                        creadoPor:u.name,
                                        prog:[]
                                    };
                                    
                                    nuevasOTs.push(nuevaOT);
                                    procesados++;
                                }catch(error){
                                    erroresDetalle.push(`Fila ${headerRow+idx+2}: ${error.message}`);
                                    errores++;
                                }
                            });
                            
                            if(nuevasOTs.length===0){
                                alert('‚ùå No se pudieron importar OTs.\n\n'+erroresDetalle.slice(0,5).join('\n'));
                                return;
                            }
                            
                            // Guardar
                            saveO([...os,...nuevasOTs]);
                            
                            // Mostrar resumen
                            let mensaje=`‚úÖ Importaci√≥n completada\n\n`;
                            mensaje+=`‚úì ${procesados} OTs importadas exitosamente\n`;
                            if(errores>0){
                                mensaje+=`‚ö† ${errores} filas con errores\n\n`;
                                mensaje+='Primeros errores:\n'+erroresDetalle.slice(0,3).join('\n');
                            }
                            alert(mensaje);
                            
                        }catch(error){
                            alert('‚ùå Error al leer el archivo:\n'+error.message+'\n\nVerifica que sea un archivo Excel v√°lido.');
                        }
                    };
                    reader.readAsArrayBuffer(file);
                };
                input.click();
            };
            
            const descargarPlantilla=()=>{
                const wb=XLSX.utils.book_new();
                
                // Crear plantilla con ejemplos
                const plantillaData=[
                    ['üìã PLANTILLA DE IMPORTACI√ìN DE √ìRDENES DE TRABAJO'],
                    [''],
                    ['INSTRUCCIONES:'],
                    ['1. Complete las columnas obligatorias (*)'],
                    ['2. Tipo puede ser: correctivo, preventivo o predictivo'],
                    ['3. Asignado debe ser un nombre de usuario existente'],
                    ['4. Deadline en formato: DD/MM/AAAA o AAAA-MM-DD'],
                    ['5. Elimine estas filas de instrucciones antes de importar'],
                    [''],
                    ['Trabajo (*)','Tipo','Asignado','Deadline','Observaciones'],
                    ['Cambio de filtro HEPA en sala limpia','preventivo','Juan P√©rez','31/12/2025','Revisar presi√≥n diferencial'],
                    ['Reparar bomba de agua fr√≠a','correctivo','Mar√≠a L√≥pez','15/11/2025','P√©rdida de presi√≥n detectada'],
                    ['Calibraci√≥n de balanza anal√≠tica','preventivo','Carlos Ruiz','20/11/2025','Calibraci√≥n anual programada']
                ];
                
                const ws=XLSX.utils.aoa_to_sheet(plantillaData);
                ws['!cols']=[{wch:50},{wch:15},{wch:20},{wch:15},{wch:40}];
                
                // Agregar formato a encabezados (fila 10)
                const headerRow=9;
                
                XLSX.utils.book_append_sheet(wb,ws,'Plantilla OTs');
                XLSX.writeFile(wb,'plantilla_importacion_OTs.xlsx');
            };
            
            const wa=(o)=>{const t=us.find(x=>x.name===o.aa)?.tel;if(!t)return alert('‚ö†Ô∏è Sin tel√©fono registrado');const tel=t.replace(/\D/g,'');const msg=`üîß *ORDEN DE TRABAJO*\n\nüìã *N¬∫:* ${o.n}\nüìä *Estado:* ${o.es}\nüìù *Trabajo:* ${o.tr}`;window.open(`https://wa.me/${tel}?text=${encodeURIComponent(msg)}`,'_blank')};
            const del=(o)=>{if(!hp('do'))return alert('Sin permiso');if(confirm('¬øEliminar orden?'))saveO(os.filter(x=>x.id!==o.id))};
            
            const columns=[
                {id:'creada',title:'üìã Creada',bg:'#fef3c7',border:'#f59e0b',orders:my.filter(o=>o.es==='creada')},
                {id:'haciendo',title:'üîß Haciendo',bg:'#dbeafe',border:'#3b82f6',orders:my.filter(o=>o.es==='haciendo')},
                {id:'hecha',title:'‚úÖ Hecha',bg:'#d1fae5',border:'#10b981',orders:my.filter(o=>o.es==='hecha')},
                {id:'registrada',title:'üìù Registrada',bg:'#e9d5ff',border:'#a855f7',orders:my.filter(o=>o.es==='registrada')},
                {id:'cerrada',title:'üîí Cerrada',bg:'#e5e7eb',border:'#6b7280',orders:my.filter(o=>o.es==='cerrada')}
            ];
            
            return(<div>
                {/* Header Dashboard */}
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'1.5rem',flexWrap:'wrap',gap:'0.5rem'}}>
                    <h2 style={{fontSize:'1.875rem',fontWeight:'bold',color:'#111827'}}>üìä Dashboard de Mantenimiento</h2>
                    <div style={{display:'flex',gap:'0.5rem',flexWrap:'wrap'}}>
                        {hp('co')&&<button onClick={descargarPlantilla} className="btn" style={{background:'#8b5cf6',color:'#fff'}}>üì• Plantilla Excel</button>}
                        {hp('co')&&<button onClick={importarOTs} className="btn" style={{background:'#10b981',color:'#fff'}}>üì§ Importar OTs</button>}
                        {u.role==='supervisor'&&<button onClick={exp} className="btn bs">üìä Exportar Excel</button>}
                    </div>
                </div>
                
                {/* Gr√°ficos OEE y Estados */}
                <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(400px,1fr))',gap:'1.5rem',marginBottom:'2rem'}}>
                    {/* Gr√°fico de Estados */}
                    <div style={{background:'#fff',borderRadius:'0.75rem',padding:'1.5rem',boxShadow:'0 1px 3px rgba(0,0,0,0.1)'}}>
                        <h3 style={{fontSize:'1.125rem',fontWeight:'700',marginBottom:'1.5rem',color:'#111827'}}>üìä Distribuci√≥n por Estados</h3>
                        <div style={{display:'flex',flexDirection:'column',gap:'1rem'}}>
                            {columns.map(col=>{
                                const count=col.orders.length;
                                const percent=my.length>0?((count/my.length)*100).toFixed(1):0;
                                return(<div key={col.id}>
                                    <div style={{display:'flex',justifyContent:'space-between',marginBottom:'0.25rem',fontSize:'0.875rem'}}>
                                        <span style={{fontWeight:'600',color:'#374151'}}>{col.title}</span>
                                        <span style={{color:'#6b7280'}}>{count} ({percent}%)</span>
                                    </div>
                                    <div style={{background:'#f3f4f6',borderRadius:'999px',height:'24px',overflow:'hidden'}}>
                                        <div style={{background:col.border,height:'100%',width:percent+'%',borderRadius:'999px',transition:'width 0.3s',display:'flex',alignItems:'center',justifyContent:'center',color:'#fff',fontSize:'0.75rem',fontWeight:'700'}}>{percent>5?percent+'%':''}</div>
                                    </div>
                                </div>);
                            })}
                        </div>
                    </div>
                    
                    {/* Gr√°fico OEE */}
                    <div style={{background:'#fff',borderRadius:'0.75rem',padding:'1.5rem',boxShadow:'0 1px 3px rgba(0,0,0,0.1)'}}>
                        <h3 style={{fontSize:'1.125rem',fontWeight:'700',marginBottom:'1.5rem',color:'#111827'}}>‚ö° Indicadores OEE</h3>
                        {(()=>{
                            const completadas=os.filter(o=>['hecha','registrada','cerrada'].includes(o.es));
                            const tiempos=completadas.filter(o=>o.in&&o.fi).map(o=>(new Date(o.fi)-new Date(o.in))/(1000*60*60));
                            const tiempoPromedio=tiempos.length>0?(tiempos.reduce((a,b)=>a+b,0)/tiempos.length).toFixed(1):'0';
                            const aTiempo=completadas.filter(o=>o.dl&&o.fi&&new Date(o.fi)<=new Date(o.dl)).length;
                            const fueraDePlazo=completadas.filter(o=>o.dl&&o.fi&&new Date(o.fi)>new Date(o.dl)).length;
                            const efectividad=completadas.length>0?((aTiempo/(aTiempo+fueraDePlazo))*100).toFixed(1):'0';
                            const disponibilidad=os.length>0?((completadas.length/os.length)*100).toFixed(1):'0';
                            
                            const metricas=[
                                {label:'Disponibilidad',value:disponibilidad,color:'#3b82f6',desc:'√ìrdenes completadas / Total'},
                                {label:'Efectividad',value:efectividad,color:'#10b981',desc:'A tiempo / Total completadas'},
                                {label:'Tiempo Promedio',value:tiempoPromedio,color:'#f59e0b',desc:'Horas por OT',unit:'hrs'}
                            ];
                            
                            return(<div style={{display:'flex',flexDirection:'column',gap:'1.25rem'}}>
                                {metricas.map((m,i)=><div key={i}>
                                    <div style={{display:'flex',justifyContent:'space-between',marginBottom:'0.5rem'}}>
                                        <div>
                                            <div style={{fontSize:'0.875rem',fontWeight:'600',color:'#374151'}}>{m.label}</div>
                                            <div style={{fontSize:'0.75rem',color:'#9ca3af',marginTop:'0.125rem'}}>{m.desc}</div>
                                        </div>
                                        <div style={{fontSize:'1.5rem',fontWeight:'700',color:m.color}}>{m.value}{m.unit||'%'}</div>
                                    </div>
                                    <div style={{background:'#f3f4f6',borderRadius:'999px',height:'12px',overflow:'hidden'}}>
                                        <div style={{background:m.color,height:'100%',width:(m.unit?Math.min(parseFloat(m.value)*2,100):m.value)+'%',borderRadius:'999px',transition:'width 0.3s'}}></div>
                                    </div>
                                </div>)}
                            </div>);
                        })()}
                    </div>
                </div>
                
                {/* Kanban */}
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'1.5rem',flexWrap:'wrap',gap:'0.5rem'}}>
                    <h2 style={{fontSize:'1.5rem',fontWeight:'bold',color:'#111827'}}>üìã Tablero Kanban</h2>
                    <div style={{display:'flex',gap:'0.5rem'}}>
                        {hp('co')&&<button onClick={()=>setM({t:'o'})} className="btn bp">+ Nueva OT</button>}
                        <button onClick={()=>setViewMode(viewMode==='kanban'?'eisenhower':'kanban')} className="btn bg">{viewMode==='kanban'?'üìä Eisenhower':'üìã Kanban'}</button>
                    </div>
                </div>
                
                {viewMode==='kanban'?(<>
                <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(320px,1fr))',gap:'1.5rem'}}>
                    {columns.map(col=><div key={col.id} style={{background:'#f9fafb',borderRadius:'0.75rem',padding:'1rem',border:'2px solid #e5e7eb'}}>
                        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'1rem',padding:'0.75rem',background:col.bg,borderRadius:'0.5rem',borderLeft:`4px solid ${col.border}`}}>
                            <h3 style={{fontSize:'1.125rem',fontWeight:'700',color:'#111827'}}>{col.title}</h3>
                            <span style={{background:'rgba(0,0,0,0.1)',padding:'0.25rem 0.75rem',borderRadius:'999px',fontSize:'0.875rem',fontWeight:'700'}}>{col.orders.length}</span>
                        </div>
                        
                        <div style={{display:'flex',flexDirection:'column',gap:'0.75rem',maxHeight:'70vh',overflowY:'auto',paddingRight:'0.25rem'}}>
                            {col.orders.length===0?
                                <div style={{textAlign:'center',padding:'2rem',color:'#9ca3af',fontSize:'0.875rem'}}>
                                    <div style={{fontSize:'3rem',marginBottom:'0.5rem'}}>üì≠</div>
                                    <p>No hay √≥rdenes</p>
                                </div>
                            :col.orders.map(o=>{
                                const getPriority=()=>{
                                    if(o.urgente&&o.importante)return {bg:'#fee2e2',color:'#991b1b',text:'üî¥ Hacer YA',border:'#ef4444'};
                                    if(o.urgente&&!o.importante)return {bg:'#fed7aa',color:'#9a3412',text:'üü† Delegar',border:'#f97316'};
                                    if(!o.urgente&&o.importante)return {bg:'#fef3c7',color:'#92400e',text:'üü° Planificar',border:'#f59e0b'};
                                    return {bg:'#d1fae5',color:'#065f46',text:'üü¢ Revisar',border:'#10b981'};
                                };
                                const priority=getPriority();
                                return(<div key={o.id} onClick={()=>setM({t:'v',d:o})} style={{background:'#fff',padding:'1rem',borderRadius:'0.5rem',border:'1px solid #e5e7eb',cursor:'pointer',transition:'all 0.2s',boxShadow:'0 1px 2px rgba(0,0,0,0.05)'}} onMouseEnter={e=>{e.currentTarget.style.transform='translateY(-2px)';e.currentTarget.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)'}} onMouseLeave={e=>{e.currentTarget.style.transform='translateY(0)';e.currentTarget.style.boxShadow='0 1px 2px rgba(0,0,0,0.05)'}}>
                                <div style={{display:'flex',justifyContent:'space-between',alignItems:'start',marginBottom:'0.75rem'}}>
                                    <div style={{flex:1}}>
                                        <div style={{display:'flex',alignItems:'center',gap:'0.5rem',marginBottom:'0.5rem'}}>
                                            <h4 style={{fontSize:'1rem',fontWeight:'700',color:'#111827',margin:0}}>{o.n}</h4>
                                            <span style={{fontSize:'0.75rem',color:'#6b7280',background:'#f3f4f6',padding:'0.125rem 0.5rem',borderRadius:'0.25rem'}}>{o.ti}</span>
                                        </div>
                                        <div style={{display:'inline-block',background:priority.bg,color:priority.color,padding:'0.25rem 0.625rem',borderRadius:'0.375rem',fontSize:'0.75rem',fontWeight:'700',border:`2px solid ${priority.border}`}}>
                                            {priority.text}
                                        </div>
                                    </div>
                                    <div style={{display:'flex',gap:'0.25rem',flexWrap:'wrap'}}>
                                        {hp('eo')&&<button onClick={(e)=>{e.stopPropagation();setM({t:'o',d:o})}} style={{border:'none',background:'#dbeafe',color:'#2563eb',cursor:'pointer',padding:'0.25rem 0.5rem',borderRadius:'0.25rem',fontSize:'0.875rem'}} title="Editar">‚úèÔ∏è</button>}
                                        {o.es!=='completada'&&<button onClick={(e)=>{e.stopPropagation();setM({t:'c',d:o})}} style={{border:'none',background:'#d1fae5',color:'#10b981',cursor:'pointer',padding:'0.25rem 0.5rem',borderRadius:'0.25rem',fontSize:'0.875rem'}} title="Cerrar">‚úÖ</button>}
                                        {(o.es==='completada'&&(u.role==='supervisor'||u.name===o.aa))&&<button onClick={(e)=>{e.stopPropagation();if(confirm('¬øReabrir orden?')){const updated={...o,es:'haciendo',fi:null};saveO(os.map(x=>x.id===o.id?updated:x))}}} style={{border:'none',background:'#fef3c7',color:'#f59e0b',cursor:'pointer',padding:'0.25rem 0.5rem',borderRadius:'0.25rem',fontSize:'0.875rem'}} title="Reabrir">‚Ü©Ô∏è</button>}
                                        {hp('do')&&<button onClick={(e)=>{e.stopPropagation();del(o)}} style={{border:'none',background:'#fee2e2',color:'#ef4444',cursor:'pointer',padding:'0.25rem 0.5rem',borderRadius:'0.25rem',fontSize:'0.875rem'}} title="Eliminar">üóëÔ∏è</button>}
                                    </div>
                                </div>
                                <p style={{fontSize:'0.875rem',color:'#374151',marginBottom:'0.75rem',lineHeight:'1.4',display:'-webkit-box',WebkitLineClamp:2,WebkitBoxOrient:'vertical',overflow:'hidden'}}>{o.tr}</p>
                                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',paddingTop:'0.75rem',borderTop:'1px solid #f3f4f6'}}>
                                    <div style={{display:'flex',alignItems:'center',gap:'0.5rem'}}>
                                        <span style={{fontSize:'0.75rem',color:'#6b7280'}}>üë§</span>
                                        <span style={{fontSize:'0.875rem',fontWeight:'600',color:'#111827'}}>{o.aa}</span>
                                    </div>
                                    {o.dl&&<div style={{display:'flex',alignItems:'center',gap:'0.25rem'}}>
                                        <span style={{fontSize:'0.75rem'}}>‚è∞</span>
                                        <span style={{fontSize:'0.75rem',color:new Date(o.dl)<new Date()&&o.es!=='completada'?'#ef4444':'#6b7280'}}>{new Date(o.dl).toLocaleDateString('es-ES',{day:'2-digit',month:'2-digit'})}</span>
                                    </div>}
                                </div>
                            </div>);
                            })}
                        </div>
                    </div>)}
                </div>
                </>):(
                    // Vista Eisenhower
                    <div style={{display:'grid',gridTemplateColumns:'repeat(2,1fr)',gap:'1.5rem'}}>
                        {[
                            {title:'üî¥ Hacer YA',desc:'Urgente + Importante',filter:(o)=>o.urgente&&o.importante,bg:'#fee2e2',border:'#ef4444'},
                            {title:'üü° Planificar',desc:'No Urgente + Importante',filter:(o)=>!o.urgente&&o.importante,bg:'#fef3c7',border:'#f59e0b'},
                            {title:'üü† Delegar',desc:'Urgente + No Importante',filter:(o)=>o.urgente&&!o.importante,bg:'#fed7aa',border:'#f97316'},
                            {title:'üü¢ Revisar',desc:'No Urgente + No Importante',filter:(o)=>!o.urgente&&!o.importante,bg:'#d1fae5',border:'#10b981'}
                        ].map((q,i)=><div key={i} style={{background:'#fff',borderRadius:'0.75rem',padding:'1.5rem',border:`3px solid ${q.border}`}}>
                            <h3 style={{fontSize:'1.25rem',fontWeight:'700',marginBottom:'0.5rem'}}>{q.title}</h3>
                            <p style={{fontSize:'0.875rem',color:'#6b7280',marginBottom:'1rem'}}>{q.desc}</p>
                            <div style={{display:'flex',flexDirection:'column',gap:'0.75rem'}}>
                                {my.filter(q.filter).map(o=><div key={o.id} onClick={()=>setM({t:'v',d:o})} style={{background:q.bg,padding:'1rem',borderRadius:'0.5rem',cursor:'pointer',border:`2px solid ${q.border}`,transition:'all 0.2s'}} onMouseEnter={e=>e.currentTarget.style.transform='scale(1.02)'} onMouseLeave={e=>e.currentTarget.style.transform='scale(1)'}>
                                    <div style={{fontWeight:'700',marginBottom:'0.5rem'}}>{o.n}</div>
                                    <div style={{fontSize:'0.875rem',color:'#374151',marginBottom:'0.5rem'}}>{o.tr?.substring(0,100)}...</div>
                                    <div style={{display:'flex',justifyContent:'space-between',fontSize:'0.75rem',color:'#6b7280'}}>
                                        <span>üë§ {o.aa}</span>
                                        <span>{o.es.toUpperCase()}</span>
                                    </div>
                                </div>)}
                                {my.filter(q.filter).length===0&&<div style={{textAlign:'center',padding:'2rem',color:'#9ca3af'}}>Sin √≥rdenes</div>}
                            </div>
                        </div>)}
                    </div>
                )}
            </div>);
        }
        
        
        function ArchivoOTs({os,us,setM,hp}){
            const[filtro,setFiltro]=useState({
                busqueda:'',
                estado:'cerrada',
                tipo:'todos',
                fechaDesde:'',
                fechaHasta:'',
                asignado:'todos'
            });
            
            // Funci√≥n para generar PDF individual
            const generarPDF=(o)=>{
                const{jsPDF}=window.jspdf;
                const doc=new jsPDF();
                const currentUser=JSON.parse(localStorage.getItem('currentUser')||'{}');
                let y=20;
                
                // HEADER
                doc.setFillColor(37,99,235);
                doc.rect(0,0,210,40,'F');
                doc.setTextColor(255,255,255);
                doc.setFontSize(24);
                doc.setFont(undefined,'bold');
                doc.text('ORDEN DE TRABAJO',105,20,'center');
                doc.setFontSize(14);
                doc.text(`N¬∫ ${o.n}`,105,30,'center');
                doc.setFontSize(9);
                doc.text(`Generado: ${new Date().toLocaleString('es-ES')}`,15,37);
                
                y=50;
                doc.setTextColor(0,0,0);
                
                // Informaci√≥n general
                doc.setFillColor(243,244,246);
                doc.rect(10,y,190,15,'F');
                doc.setFontSize(10);
                doc.setFont(undefined,'bold');
                doc.text('INFORMACI√ìN GENERAL',15,y+10);
                y+=20;
                doc.setFontSize(9);
                doc.setFont(undefined,'normal');
                doc.text(`Tipo: ${o.ti.toUpperCase()}`,15,y);
                doc.text(`Estado: ${o.es.toUpperCase()}`,110,y);
                y+=10;
                
                // Personal
                doc.setFillColor(243,244,246);
                doc.rect(10,y,190,15,'F');
                doc.setFont(undefined,'bold');
                doc.setFontSize(10);
                doc.text('PERSONAL',15,y+10);
                y+=20;
                doc.setFont(undefined,'normal');
                doc.setFontSize(9);
                doc.text(`Asignado a: ${o.aa}`,15,y);
                doc.text(`Creado por: ${o.creadoPor||'N/A'}`,110,y);
                y+=15;
                
                // Descripci√≥n
                doc.setFillColor(255,251,235);
                doc.rect(10,y,190,8,'F');
                doc.setFont(undefined,'bold');
                doc.setFontSize(10);
                doc.text('TRABAJO A REALIZAR',15,y+6);
                y+=12;
                doc.setFont(undefined,'normal');
                doc.setFontSize(9);
                const descLines=doc.splitTextToSize(o.tr,170);
                doc.text(descLines,15,y);
                y+=descLines.length*5+10;
                
                // Trabajos realizados
                if(o.trab){
                    doc.setFillColor(209,250,229);
                    doc.rect(10,y,190,8,'F');
                    doc.setFont(undefined,'bold');
                    doc.setFontSize(10);
                    doc.text('TRABAJOS REALIZADOS',15,y+6);
                    y+=12;
                    doc.setFont(undefined,'normal');
                    doc.setFontSize(9);
                    const trabLines=doc.splitTextToSize(o.trab,170);
                    doc.text(trabLines,15,y);
                    y+=trabLines.length*5+10;
                }
                
                // Fechas
                if(o.in||o.dl||o.fi){
                    doc.setFillColor(243,244,246);
                    doc.rect(10,y,190,8,'F');
                    doc.setFont(undefined,'bold');
                    doc.setFontSize(10);
                    doc.text('FECHAS',15,y+6);
                    y+=12;
                    doc.setFont(undefined,'normal');
                    doc.setFontSize(9);
                    if(o.in){doc.text(`Inicio: ${new Date(o.in).toLocaleString('es-ES')}`,15,y);y+=6;}
                    if(o.dl){doc.text(`Deadline: ${new Date(o.dl).toLocaleString('es-ES')}`,15,y);y+=6;}
                    if(o.fi){doc.text(`Fin: ${new Date(o.fi).toLocaleString('es-ES')}`,15,y);y+=6;}
                    y+=8;
                }
                
                // Repuestos
                if(o.rp?.length>0){
                    if(y>250){doc.addPage();y=20;}
                    doc.setFillColor(243,244,246);
                    doc.rect(10,y,190,8,'F');
                    doc.setFont(undefined,'bold');
                    doc.setFontSize(10);
                    doc.text('REPUESTOS',15,y+6);
                    y+=12;
                    doc.setFontSize(8);
                    doc.setFont(undefined,'bold');
                    doc.text('REPUESTO',15,y);
                    doc.text('CANTIDAD',170,y);
                    y+=5;
                    doc.line(10,y,200,y);
                    y+=5;
                    doc.setFont(undefined,'normal');
                    o.rp.forEach(r=>{
                        if(y>280){doc.addPage();y=20;}
                        doc.text(r.nom,15,y);
                        doc.text(String(r.cant),170,y);
                        y+=5;
                    });
                    y+=10;
                }
                
                // Resultado
                if(o.re){
                    if(y>250){doc.addPage();y=20;}
                    doc.setFillColor(o.re==='ok'?209:254,o.re==='ok'?250:226,o.re==='ok'?229:226);
                    doc.rect(10,y,190,15,'F');
                    doc.setFont(undefined,'bold');
                    doc.setFontSize(12);
                    doc.setTextColor(o.re==='ok'?6:153,o.re==='ok'?95:27,o.re==='ok'?70:27);
                    doc.text(o.re==='ok'?'‚úì SOLUCIONADO':'‚úó NO SOLUCIONADO',105,y+10,'center');
                    doc.setTextColor(0,0,0);
                    y+=20;
                }
                
                // Observaciones
                if(o.ob||o.obsc){
                    if(y>250){doc.addPage();y=20;}
                    doc.setFillColor(243,244,246);
                    doc.rect(10,y,190,8,'F');
                    doc.setFont(undefined,'bold');
                    doc.setFontSize(10);
                    doc.text('OBSERVACIONES',15,y+6);
                    y+=12;
                    doc.setFont(undefined,'normal');
                    doc.setFontSize(9);
                    const obsLines=doc.splitTextToSize(o.obsc||o.ob,170);
                    doc.text(obsLines,15,y);
                    y+=obsLines.length*5+15;
                }
                
                // Firmas GMP
                if(o.es==='cerrada'){
                    if(y>230){doc.addPage();y=20;}
                    doc.setFillColor(243,244,246);
                    doc.rect(10,y,190,8,'F');
                    doc.setFont(undefined,'bold');
                    doc.setFontSize(10);
                    doc.text('FIRMAS - GMP',15,y+6);
                    y+=15;
                    doc.setFontSize(9);
                    doc.line(15,y+20,90,y+20);
                    doc.text('Realizado por:',15,y+25);
                    doc.text(o.aa,15,y+30);
                    doc.line(110,y+20,185,y+20);
                    doc.text('Supervisor:',110,y+25);
                    doc.text(currentUser.name||'___________',110,y+30);
                    y+=40;
                    doc.text(`Fecha: ${o.fi?new Date(o.fi).toLocaleString('es-ES'):'N/A'}`,15,y);
                }
                
                // Footer
                const pageCount=doc.internal.getNumberOfPages();
                for(let i=1;i<=pageCount;i++){
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(128,128,128);
                    doc.text(`OT-${o.n} | P√°gina ${i} de ${pageCount}`,105,290,'center');
                    doc.text('Sistema GMP',105,295,'center');
                }
                
                return doc;
            };
            
            // Filtrar OTs
            const otsFiltradas=os.filter(o=>{
                // Solo cerradas
                if(filtro.estado&&o.es!==filtro.estado)return false;
                
                // B√∫squeda por n√∫mero o descripci√≥n
                if(filtro.busqueda&&!o.n.toLowerCase().includes(filtro.busqueda.toLowerCase())&&!o.tr.toLowerCase().includes(filtro.busqueda.toLowerCase()))return false;
                
                // Filtro por tipo
                if(filtro.tipo!=='todos'&&o.ti!==filtro.tipo)return false;
                
                // Filtro por asignado
                if(filtro.asignado!=='todos'&&o.aa!==filtro.asignado)return false;
                
                // Filtro por rango de fechas
                if(filtro.fechaDesde&&o.fi&&new Date(o.fi)<new Date(filtro.fechaDesde))return false;
                if(filtro.fechaHasta&&o.fi&&new Date(o.fi)>new Date(filtro.fechaHasta))return false;
                
                return true;
            });
            
            return(<div style={{background:'#fff',borderRadius:'0.5rem',padding:'1.5rem'}}>
                {/* Header */}
                <div style={{marginBottom:'2rem'}}>
                    <h2 style={{fontSize:'1.875rem',fontWeight:'bold',color:'#111827',marginBottom:'0.5rem'}}>üìÅ Archivo de √ìrdenes de Trabajo</h2>
                    <p style={{color:'#6b7280',fontSize:'0.95rem'}}>Consulta, filtra y descarga PDFs de OTs cerradas (Cumplimiento GMP)</p>
                </div>
                
                {/* Filtros */}
                <div style={{background:'#f9fafb',padding:'1.5rem',borderRadius:'0.5rem',marginBottom:'2rem',border:'1px solid #e5e7eb'}}>
                    <h3 style={{fontSize:'1rem',fontWeight:'600',color:'#111827',marginBottom:'1rem'}}>üîç Filtros de B√∫squeda</h3>
                    <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(200px,1fr))',gap:'1rem'}}>
                        <div>
                            <label style={{display:'block',fontSize:'0.875rem',fontWeight:'600',color:'#374151',marginBottom:'0.5rem'}}>Buscar (N¬∫ o descripci√≥n)</label>
                            <input value={filtro.busqueda} onChange={e=>setFiltro({...filtro,busqueda:e.target.value})} placeholder="OT-001 o cambio filtro..." style={{marginBottom:0}}/>
                        </div>
                        <div>
                            <label style={{display:'block',fontSize:'0.875rem',fontWeight:'600',color:'#374151',marginBottom:'0.5rem'}}>Estado</label>
                            <select value={filtro.estado} onChange={e=>setFiltro({...filtro,estado:e.target.value})} style={{marginBottom:0}}>
                                <option value="">Todos</option>
                                <option value="cerrada">Cerradas</option>
                                <option value="registrada">Registradas</option>
                                <option value="hecha">Hechas</option>
                            </select>
                        </div>
                        <div>
                            <label style={{display:'block',fontSize:'0.875rem',fontWeight:'600',color:'#374151',marginBottom:'0.5rem'}}>Tipo</label>
                            <select value={filtro.tipo} onChange={e=>setFiltro({...filtro,tipo:e.target.value})} style={{marginBottom:0}}>
                                <option value="todos">Todos</option>
                                <option value="correctivo">Correctivo</option>
                                <option value="preventivo">Preventivo</option>
                                <option value="predictivo">Predictivo</option>
                            </select>
                        </div>
                        <div>
                            <label style={{display:'block',fontSize:'0.875rem',fontWeight:'600',color:'#374151',marginBottom:'0.5rem'}}>Asignado a</label>
                            <select value={filtro.asignado} onChange={e=>setFiltro({...filtro,asignado:e.target.value})} style={{marginBottom:0}}>
                                <option value="todos">Todos</option>
                                {[...new Set(os.map(o=>o.aa))].map(a=><option key={a} value={a}>{a}</option>)}
                            </select>
                        </div>
                        <div>
                            <label style={{display:'block',fontSize:'0.875rem',fontWeight:'600',color:'#374151',marginBottom:'0.5rem'}}>Desde</label>
                            <input type="date" value={filtro.fechaDesde} onChange={e=>setFiltro({...filtro,fechaDesde:e.target.value})} style={{marginBottom:0}}/>
                        </div>
                        <div>
                            <label style={{display:'block',fontSize:'0.875rem',fontWeight:'600',color:'#374151',marginBottom:'0.5rem'}}>Hasta</label>
                            <input type="date" value={filtro.fechaHasta} onChange={e=>setFiltro({...filtro,fechaHasta:e.target.value})} style={{marginBottom:0}}/>
                        </div>
                    </div>
                    <button onClick={()=>setFiltro({busqueda:'',estado:'cerrada',tipo:'todos',fechaDesde:'',fechaHasta:'',asignado:'todos'})} className="btn bg" style={{marginTop:'1rem'}}>üîÑ Limpiar Filtros</button>
                </div>
                
                {/* Estad√≠sticas */}
                <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(150px,1fr))',gap:'1rem',marginBottom:'2rem'}}>
                    <div style={{background:'linear-gradient(135deg,#3b82f6,#2563eb)',color:'#fff',padding:'1.5rem',borderRadius:'0.5rem',textAlign:'center',boxShadow:'0 4px 6px rgba(37,99,235,0.2)'}}>
                        <p style={{fontSize:'2rem',fontWeight:'bold',margin:0}}>{otsFiltradas.length}</p>
                        <p style={{fontSize:'0.875rem',opacity:0.9,margin:0}}>OTs Filtradas</p>
                    </div>
                    <div style={{background:'linear-gradient(135deg,#10b981,#059669)',color:'#fff',padding:'1.5rem',borderRadius:'0.5rem',textAlign:'center',boxShadow:'0 4px 6px rgba(16,185,129,0.2)'}}>
                        <p style={{fontSize:'2rem',fontWeight:'bold',margin:0}}>{os.filter(o=>o.es==='cerrada').length}</p>
                        <p style={{fontSize:'0.875rem',opacity:0.9,margin:0}}>Total Cerradas</p>
                    </div>
                </div>
                
                {/* Lista de OTs */}
                <div style={{marginBottom:'1rem',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                    <h3 style={{fontSize:'1.125rem',fontWeight:'600',color:'#111827'}}>Resultados ({otsFiltradas.length})</h3>
                </div>
                
                {otsFiltradas.length>0?<div style={{border:'1px solid #e5e7eb',borderRadius:'0.5rem',overflow:'hidden'}}>
                    {otsFiltradas.sort((a,b)=>new Date(b.fi||b.cr)-new Date(a.fi||a.cr)).map((o,i)=><div key={o.id} style={{padding:'1.25rem',borderBottom:i<otsFiltradas.length-1?'1px solid #e5e7eb':'none',background:i%2===0?'#fff':'#f9fafb',display:'flex',justifyContent:'space-between',alignItems:'center',gap:'1rem',flexWrap:'wrap'}}>
                        <div style={{flex:1,minWidth:'200px'}}>
                            <div style={{display:'flex',alignItems:'center',gap:'0.75rem',marginBottom:'0.5rem'}}>
                                <span style={{fontSize:'1.125rem',fontWeight:'700',color:'#2563eb'}}>{o.n}</span>
                                <span style={{padding:'0.25rem 0.75rem',background:o.es==='cerrada'?'#6b7280':'#3b82f6',color:'#fff',borderRadius:'999px',fontSize:'0.75rem',fontWeight:'600'}}>{o.es.toUpperCase()}</span>
                                <span style={{padding:'0.25rem 0.75rem',background:'#f3f4f6',color:'#374151',borderRadius:'999px',fontSize:'0.75rem',fontWeight:'600'}}>{o.ti}</span>
                            </div>
                            <p style={{color:'#6b7280',fontSize:'0.875rem',marginBottom:'0.25rem'}}>{o.tr.substring(0,100)}{o.tr.length>100?'...':''}</p>
                            <div style={{display:'flex',gap:'1rem',fontSize:'0.75rem',color:'#9ca3af',marginTop:'0.5rem'}}>
                                <span>üë§ {o.aa}</span>
                                {o.fi&&<span>üìÖ {new Date(o.fi).toLocaleDateString('es-ES')}</span>}
                            </div>
                        </div>
                        <div style={{display:'flex',gap:'0.5rem'}}>
                            <button onClick={()=>setM({t:'v',d:o})} className="btn bp" style={{padding:'0.5rem 1rem',fontSize:'0.875rem'}}>üëÅÔ∏è Ver</button>
                            {hp('pdf')&&o.es==='cerrada'&&<button onClick={()=>{
                                const doc=generarPDF(o);
                                doc.save(`OT-${o.n}_${new Date().toISOString().split('T')[0]}.pdf`);
                            }} className="btn" style={{padding:'0.5rem 1rem',fontSize:'0.875rem',background:'#dc2626',color:'#fff'}}>üìÑ PDF</button>}
                            {hp('imp')&&o.es==='cerrada'&&<button onClick={()=>{
                                const doc=generarPDF(o);
                                const pdfBlob=doc.output('blob');
                                const pdfUrl=URL.createObjectURL(pdfBlob);
                                const printWindow=window.open(pdfUrl,'_blank');
                                printWindow.onload=function(){printWindow.print();};
                            }} className="btn" style={{padding:'0.5rem 1rem',fontSize:'0.875rem',background:'#7c3aed',color:'#fff'}}>üñ®Ô∏è</button>}
                        </div>
                    </div>)}
                </div>:<div style={{textAlign:'center',padding:'3rem',color:'#9ca3af'}}>
                    <p style={{fontSize:'1.25rem',marginBottom:'0.5rem'}}>üì≠ No hay OTs que coincidan con los filtros</p>
                    <p style={{fontSize:'0.875rem'}}>Intenta ajustar los criterios de b√∫squeda</p>
                </div>}
            </div>);
        }
        
        function Users({us,saveU,setM,hp}){
            const del=(x)=>{if(!hp('du'))return alert('Sin permiso');if(x.role==='supervisor')return alert('No eliminar supervisor');if(confirm('¬øEliminar?'))saveU(us.filter(u=>u.id!==x.id))};
            return(<div style={{background:'#fff',borderRadius:'0.5rem',padding:'1.5rem'}}>
                <div style={{display:'flex',justifyContent:'space-between',marginBottom:'1.5rem'}}>
                    <h2 style={{fontSize:'1.5rem',fontWeight:'bold'}}>Usuarios</h2>
                    {hp('cu')&&<button onClick={()=>setM({t:'u'})} className="btn bp">+ Nuevo</button>}
                </div>
                {us.map(x=><div key={x.id} style={{padding:'1rem',border:'1px solid #e5e7eb',borderRadius:'0.5rem',marginBottom:'0.75rem',display:'flex',justifyContent:'space-between'}}>
                    <div><p style={{fontWeight:'600'}}>{x.name}</p><p style={{fontSize:'0.875rem',color:'#6b7280'}}>@{x.username}</p><span style={{padding:'0.25rem 0.5rem',borderRadius:'0.25rem',fontSize:'0.75rem',fontWeight:'600',background:x.role==='supervisor'?'#ddd6fe':x.role==='creador'?'#dbeafe':'#e5e7eb'}}>{x.role}</span></div>
                    <div style={{display:'flex',gap:'0.5rem'}}>
                        {hp('eu')&&<button onClick={()=>setM({t:'u',d:x})} style={{border:'none',background:'none',cursor:'pointer',color:'#2563eb'}}>‚úèÔ∏è</button>}
                        {hp('du')&&x.role!=='supervisor'&&<button onClick={()=>del(x)} style={{border:'none',background:'none',cursor:'pointer',color:'#ef4444'}}>üóëÔ∏è</button>}
                    </div>
                </div>)}
            </div>);
        }
        
        function Inventario({inv,saveInv,u,hp}){
            const[edit,setEdit]=useState(null);
            const[f,setF]=useState({codigo:'',nombre:'',categoria:'',cantidad:0,unidad:'unidad',ubicacion:'',minimo:0});
            const[filtro,setFiltro]=useState('');
            
            const cats=[...new Set(inv.map(i=>i.categoria))];
            const filtrados=filtro?inv.filter(i=>i.nombre.toLowerCase().includes(filtro.toLowerCase())||i.codigo.toLowerCase().includes(filtro.toLowerCase())||i.categoria.toLowerCase().includes(filtro.toLowerCase())):inv;
            
            const nuevoItem=()=>{
                if(!hp('ar'))return alert('No tienes permiso para a√±adir repuestos');
                if(!f.codigo||!f.nombre||!f.categoria)return alert('Complete campos obligatorios');
                saveInv([...inv,{...f,id:Date.now()}]);
                setF({codigo:'',nombre:'',categoria:'',cantidad:0,unidad:'unidad',ubicacion:'',minimo:0});
            };
            
            const editarItem=()=>{
                if(!hp('ei'))return alert('No tienes permiso para editar inventario');
                if(!f.codigo||!f.nombre||!f.categoria)return alert('Complete campos obligatorios');
                saveInv(inv.map(i=>i.id===edit.id?{...f,id:edit.id}:i));
                setEdit(null);
                setF({codigo:'',nombre:'',categoria:'',cantidad:0,unidad:'unidad',ubicacion:'',minimo:0});
            };
            
            const eliminarItem=(id)=>{
                if(!hp('er'))return alert('No tienes permiso para eliminar repuestos');
                if(confirm('¬øEliminar repuesto?'))saveInv(inv.filter(i=>i.id!==id));
            };
            
            const exportarExcel=()=>{
                const wb=XLSX.utils.book_new();
                const data=[
                    ['üì¶ INVENTARIO DE REPUESTOS','','','','','',''],
                    [''],
                    ['C√≥digo','Nombre','Categor√≠a','Cantidad','Unidad','Ubicaci√≥n','M√≠nimo'],
                    ...inv.map(i=>[i.codigo,i.nombre,i.categoria,i.cantidad,i.unidad,i.ubicacion,i.minimo])
                ];
                const ws=XLSX.utils.aoa_to_sheet(data);
                ws['!cols']=[{wch:12},{wch:30},{wch:15},{wch:10},{wch:10},{wch:12},{wch:10}];
                XLSX.utils.book_append_sheet(wb,ws,'Inventario');
                XLSX.writeFile(wb,'inventario_repuestos.xlsx');
            };
            
            const importarExcel=()=>{
                const input=document.createElement('input');
                input.type='file';
                input.accept='.xlsx,.xls,.csv';
                input.onchange=(e)=>{
                    const file=e.target.files[0];
                    if(!file)return;
                    
                    const reader=new FileReader();
                    reader.onload=(evt)=>{
                        try{
                            const data=new Uint8Array(evt.target.result);
                            const workbook=XLSX.read(data,{type:'array'});
                            const firstSheet=workbook.Sheets[workbook.SheetNames[0]];
                            const jsonData=XLSX.utils.sheet_to_json(firstSheet,{header:1});
                            
                            // Buscar fila de encabezados (debe contener "C√≥digo" o "Codigo")
                            let headerRow=-1;
                            for(let i=0;i<Math.min(10,jsonData.length);i++){
                                const row=jsonData[i];
                                if(row.some(cell=>cell&&cell.toString().toLowerCase().includes('c√≥digo')||cell&&cell.toString().toLowerCase().includes('codigo'))){
                                    headerRow=i;
                                    break;
                                }
                            }
                            
                            if(headerRow===-1){
                                alert('‚ùå No se encontraron encabezados v√°lidos.\nEl archivo debe tener columnas: C√≥digo, Nombre, Categor√≠a, Cantidad, Unidad, Ubicaci√≥n, M√≠nimo');
                                return;
                            }
                            
                            const headers=jsonData[headerRow].map(h=>h?h.toString().toLowerCase().trim():'');
                            const dataRows=jsonData.slice(headerRow+1);
                            
                            // Mapear columnas
                            const colMap={
                                codigo:headers.findIndex(h=>h.includes('c√≥digo')||h.includes('codigo')),
                                nombre:headers.findIndex(h=>h.includes('nombre')),
                                categoria:headers.findIndex(h=>h.includes('categor√≠a')||h.includes('categoria')),
                                cantidad:headers.findIndex(h=>h.includes('cantidad')),
                                unidad:headers.findIndex(h=>h.includes('unidad')),
                                ubicacion:headers.findIndex(h=>h.includes('ubicaci√≥n')||h.includes('ubicacion')),
                                minimo:headers.findIndex(h=>h.includes('m√≠nimo')||h.includes('minimo'))
                            };
                            
                            // Validar que tenemos las columnas m√≠nimas
                            if(colMap.codigo===-1||colMap.nombre===-1||colMap.categoria===-1){
                                alert('‚ùå Faltan columnas requeridas.\nDebe tener al menos: C√≥digo, Nombre, Categor√≠a');
                                return;
                            }
                            
                            // Procesar filas
                            const nuevosItems=[];
                            let procesados=0;
                            let errores=0;
                            
                            dataRows.forEach((row,idx)=>{
                                if(!row||row.length===0||!row[colMap.codigo])return; // Saltar filas vac√≠as
                                
                                try{
                                    const item={
                                        id:Date.now()+idx,
                                        codigo:row[colMap.codigo]?.toString().trim()||'',
                                        nombre:row[colMap.nombre]?.toString().trim()||'',
                                        categoria:row[colMap.categoria]?.toString().trim()||'',
                                        cantidad:colMap.cantidad!==-1?parseInt(row[colMap.cantidad])||0:0,
                                        unidad:colMap.unidad!==-1?row[colMap.unidad]?.toString().trim()||'unidad':'unidad',
                                        ubicacion:colMap.ubicacion!==-1?row[colMap.ubicacion]?.toString().trim()||'':'',
                                        minimo:colMap.minimo!==-1?parseInt(row[colMap.minimo])||0:0
                                    };
                                    
                                    if(item.codigo&&item.nombre&&item.categoria){
                                        nuevosItems.push(item);
                                        procesados++;
                                    }
                                }catch(err){
                                    console.error('Error en fila',idx,err);
                                    errores++;
                                }
                            });
                            
                            if(nuevosItems.length===0){
                                alert('‚ùå No se encontraron datos v√°lidos para importar');
                                return;
                            }
                            
                            // Preguntar si sobrescribir o agregar
                            const accion=confirm(
                                `üì¶ Se encontraron ${nuevosItems.length} repuestos v√°lidos.\n\n`+
                                `‚úÖ Aceptar: AGREGAR a inventario existente\n`+
                                `‚ùå Cancelar: REEMPLAZAR inventario completo\n\n`+
                                `¬øDeseas AGREGAR al inventario actual?`
                            );
                            
                            if(accion){
                                // Agregar al inventario existente (evitar duplicados por c√≥digo)
                                const codigosExistentes=inv.map(i=>i.codigo.toLowerCase());
                                const itemsNuevos=nuevosItems.filter(item=>!codigosExistentes.includes(item.codigo.toLowerCase()));
                                const itemsActualizados=nuevosItems.filter(item=>codigosExistentes.includes(item.codigo.toLowerCase()));
                                
                                // Actualizar cantidades de items existentes
                                const invActualizado=inv.map(item=>{
                                    const itemNuevo=itemsActualizados.find(i=>i.codigo.toLowerCase()===item.codigo.toLowerCase());
                                    if(itemNuevo){
                                        return {...item,cantidad:item.cantidad+itemNuevo.cantidad};
                                    }
                                    return item;
                                });
                                
                                saveInv([...invActualizado,...itemsNuevos]);
                                alert(`‚úÖ Importaci√≥n exitosa!\n\nüì¶ ${itemsNuevos.length} repuestos nuevos agregados\nüîÑ ${itemsActualizados.length} repuestos actualizados`);
                            }else{
                                // Reemplazar inventario completo
                                if(confirm('‚ö†Ô∏è ¬øCONFIRMAS reemplazar TODO el inventario actual?')){
                                    saveInv(nuevosItems);
                                    alert(`‚úÖ Inventario reemplazado!\n\nüì¶ ${nuevosItems.length} repuestos cargados`);
                                }
                            }
                            
                        }catch(err){
                            console.error(err);
                            alert('‚ùå Error al procesar el archivo: '+err.message);
                        }
                    };
                    reader.readAsArrayBuffer(file);
                };
                input.click();
            };
            
            const descargarPlantillaRepuestos=()=>{
                const wb=XLSX.utils.book_new();
                
                // Crear plantilla con ejemplos
                const plantillaData=[
                    ['üì¶ PLANTILLA DE IMPORTACI√ìN DE REPUESTOS'],
                    [''],
                    ['INSTRUCCIONES:'],
                    ['1. Complete las columnas obligatorias marcadas con (*)'],
                    ['2. Unidad puede ser: unidad, litros, kilos, metros, pares, cajas'],
                    ['3. Cantidad y M√≠nimo son n√∫meros'],
                    ['4. Elimine estas filas de instrucciones antes de importar'],
                    [''],
                    ['C√≥digo (*)','Nombre (*)','Categor√≠a (*)','Cantidad','Unidad','Ubicaci√≥n','M√≠nimo'],
                    ['FILT-001','Filtro HEPA H14','Filtros',5,'unidad','A1',2],
                    ['BOMBA-002','Bomba centr√≠fuga 2HP','Bombas',2,'unidad','B3',1],
                    ['SELLO-003','Sello mec√°nico tipo A','Sellos',10,'unidad','C5',5],
                    ['LUBR-004','Aceite sint√©tico 5W30','Lubricantes',20,'litros','D2',10],
                    ['JUNTA-005','Junta de neopreno 2"','Juntas',15,'unidad','E4',8]
                ];
                
                const ws=XLSX.utils.aoa_to_sheet(plantillaData);
                ws['!cols']=[{wch:15},{wch:30},{wch:15},{wch:10},{wch:10},{wch:12},{wch:10}];
                
                XLSX.utils.book_append_sheet(wb,ws,'Plantilla Repuestos');
                XLSX.writeFile(wb,'plantilla_importacion_repuestos.xlsx');
            };
            
            return(<div style={{background:'#fff',borderRadius:'0.5rem',padding:'1.5rem'}}>
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'1.5rem'}}>
                    <h2 style={{fontSize:'1.5rem',fontWeight:'bold'}}>üì¶ Inventario de Repuestos</h2>
                    <div style={{display:'flex',gap:'0.5rem',flexWrap:'wrap'}}>
                        {u.role==='supervisor'&&<button onClick={descargarPlantillaRepuestos} className="btn" style={{background:'#8b5cf6',color:'#fff'}}>üì• Plantilla</button>}
                        {u.role==='supervisor'&&<button onClick={importarExcel} className="btn" style={{background:'#10b981',color:'#fff'}}>üì§ Importar</button>}
                        <button onClick={exportarExcel} className="btn bs">üìä Exportar</button>
                    </div>
                </div>
                
                {/* Formulario */}
                {(hp('ar')||hp('ei'))&&<div style={{background:'#f9fafb',padding:'1rem',borderRadius:'0.5rem',marginBottom:'1.5rem',border:'1px solid #e5e7eb'}}>
                    <h3 style={{fontSize:'1rem',fontWeight:'700',marginBottom:'1rem'}}>{edit?'‚úèÔ∏è Editar':'‚ûï Agregar'} Repuesto</h3>
                    <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(200px,1fr))',gap:'1rem'}}>
                        <div><label style={{display:'block',fontSize:'0.875rem',marginBottom:'0.25rem',fontWeight:'600'}}>C√≥digo *</label><input type="text" placeholder="REP-001" value={f.codigo} onChange={e=>setF({...f,codigo:e.target.value})} style={{marginBottom:0}}/></div>
                        <div><label style={{display:'block',fontSize:'0.875rem',marginBottom:'0.25rem',fontWeight:'600'}}>Nombre *</label><input type="text" placeholder="Filtro de aceite" value={f.nombre} onChange={e=>setF({...f,nombre:e.target.value})} style={{marginBottom:0}}/></div>
                        <div><label style={{display:'block',fontSize:'0.875rem',marginBottom:'0.25rem',fontWeight:'600'}}>Categor√≠a *</label><input type="text" placeholder="Filtros" value={f.categoria} onChange={e=>setF({...f,categoria:e.target.value})} style={{marginBottom:0}} list="cats"/><datalist id="cats">{cats.map(c=><option key={c} value={c}/>)}</datalist></div>
                        <div><label style={{display:'block',fontSize:'0.875rem',marginBottom:'0.25rem',fontWeight:'600'}}>Cantidad</label><input type="number" value={f.cantidad} onChange={e=>setF({...f,cantidad:parseInt(e.target.value)||0})} style={{marginBottom:0}}/></div>
                        <div><label style={{display:'block',fontSize:'0.875rem',marginBottom:'0.25rem',fontWeight:'600'}}>Unidad</label><select value={f.unidad} onChange={e=>setF({...f,unidad:e.target.value})} style={{marginBottom:0}}><option value="unidad">Unidad</option><option value="litros">Litros</option><option value="kilos">Kilos</option><option value="metros">Metros</option><option value="pares">Pares</option><option value="cajas">Cajas</option></select></div>
                        <div><label style={{display:'block',fontSize:'0.875rem',marginBottom:'0.25rem',fontWeight:'600'}}>Ubicaci√≥n</label><input type="text" placeholder="A1" value={f.ubicacion} onChange={e=>setF({...f,ubicacion:e.target.value})} style={{marginBottom:0}}/></div>
                        <div><label style={{display:'block',fontSize:'0.875rem',marginBottom:'0.25rem',fontWeight:'600'}}>Stock M√≠nimo</label><input type="number" value={f.minimo} onChange={e=>setF({...f,minimo:parseInt(e.target.value)||0})} style={{marginBottom:0}}/></div>
                    </div>
                    <div style={{display:'flex',gap:'0.5rem',marginTop:'1rem'}}>
                        {edit?<>{hp('ei')&&<button onClick={editarItem} className="btn bp">Guardar Cambios</button>}<button onClick={()=>{setEdit(null);setF({codigo:'',nombre:'',categoria:'',cantidad:0,unidad:'unidad',ubicacion:'',minimo:0})}} className="btn bg">Cancelar</button></>:<>{hp('ar')&&<button onClick={nuevoItem} className="btn bs">‚ûï Agregar</button>}</>}
                    </div>
                </div>}
                
                {/* Filtro */}
                <div style={{marginBottom:'1rem'}}>
                    <input type="text" placeholder="üîç Buscar por c√≥digo, nombre o categor√≠a..." value={filtro} onChange={e=>setFiltro(e.target.value)} style={{marginBottom:0}}/>
                </div>
                
                {/* Tabla */}
                <div style={{overflowX:'auto'}}>
                    <table>
                        <thead>
                            <tr>
                                <th>C√≥digo</th>
                                <th>Nombre</th>
                                <th>Categor√≠a</th>
                                <th style={{textAlign:'center'}}>Cantidad</th>
                                <th>Unidad</th>
                                <th style={{textAlign:'center'}}>Ubicaci√≥n</th>
                                <th style={{textAlign:'center'}}>M√≠nimo</th>
                                <th style={{textAlign:'center'}}>Estado</th>
                                <th style={{textAlign:'center'}}>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {filtrados.length===0?<tr><td colSpan="9" style={{textAlign:'center',padding:'2rem',color:'#9ca3af'}}>No hay repuestos{filtro?' que coincidan con la b√∫squeda':''}</td></tr>:filtrados.map(i=><tr key={i.id}>
                                <td><span style={{fontFamily:'monospace',fontWeight:'700',color:'#2563eb'}}>{i.codigo}</span></td>
                                <td>{i.nombre}</td>
                                <td><span style={{background:'#dbeafe',color:'#1e40af',padding:'0.25rem 0.5rem',borderRadius:'0.25rem',fontSize:'0.75rem',fontWeight:'600'}}>{i.categoria}</span></td>
                                <td style={{textAlign:'center',fontWeight:'700',fontSize:'1.125rem',color:i.cantidad<=i.minimo?'#ef4444':i.cantidad<=i.minimo*1.5?'#f59e0b':'#10b981'}}>{i.cantidad}</td>
                                <td style={{fontSize:'0.875rem',color:'#6b7280'}}>{i.unidad}</td>
                                <td style={{textAlign:'center'}}><span style={{background:'#f3f4f6',padding:'0.25rem 0.5rem',borderRadius:'0.25rem',fontFamily:'monospace',fontSize:'0.875rem'}}>{i.ubicacion||'-'}</span></td>
                                <td style={{textAlign:'center',color:'#6b7280'}}>{i.minimo}</td>
                                <td style={{textAlign:'center'}}>{i.cantidad<=i.minimo?<span style={{background:'#fee2e2',color:'#991b1b',padding:'0.25rem 0.5rem',borderRadius:'0.25rem',fontSize:'0.75rem',fontWeight:'700'}}>‚ö†Ô∏è Bajo</span>:i.cantidad<=i.minimo*1.5?<span style={{background:'#fef3c7',color:'#92400e',padding:'0.25rem 0.5rem',borderRadius:'0.25rem',fontSize:'0.75rem',fontWeight:'700'}}>‚ö° Medio</span>:<span style={{background:'#d1fae5',color:'#065f46',padding:'0.25rem 0.5rem',borderRadius:'0.25rem',fontSize:'0.75rem',fontWeight:'700'}}>‚úÖ OK</span>}</td>
                                <td style={{textAlign:'center'}}>
                                    {hp('ei')&&<button onClick={()=>{setEdit(i);setF(i)}} style={{border:'none',background:'#dbeafe',color:'#2563eb',cursor:'pointer',padding:'0.25rem 0.5rem',borderRadius:'0.25rem',marginRight:'0.25rem'}}>‚úèÔ∏è</button>}
                                    {hp('er')&&<button onClick={()=>eliminarItem(i.id)} style={{border:'none',background:'#fee2e2',color:'#ef4444',cursor:'pointer',padding:'0.25rem 0.5rem',borderRadius:'0.25rem'}}>üóëÔ∏è</button>}
                                    {!hp('ei')&&!hp('er')&&<span style={{color:'#9ca3af',fontSize:'0.75rem'}}>-</span>}
                                </td>
                            </tr>)}
                        </tbody>
                    </table>
                </div>
                
                {/* Resumen */}
                <div style={{marginTop:'1.5rem',padding:'1rem',background:'#f9fafb',borderRadius:'0.5rem',display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(200px,1fr))',gap:'1rem'}}>
                    <div><span style={{fontSize:'0.875rem',color:'#6b7280'}}>Total items:</span><span style={{fontSize:'1.25rem',fontWeight:'700',marginLeft:'0.5rem',color:'#111827'}}>{inv.length}</span></div>
                    <div><span style={{fontSize:'0.875rem',color:'#6b7280'}}>Categor√≠as:</span><span style={{fontSize:'1.25rem',fontWeight:'700',marginLeft:'0.5rem',color:'#111827'}}>{cats.length}</span></div>
                    <div><span style={{fontSize:'0.875rem',color:'#6b7280'}}>Stock bajo:</span><span style={{fontSize:'1.25rem',fontWeight:'700',marginLeft:'0.5rem',color:'#ef4444'}}>{inv.filter(i=>i.cantidad<=i.minimo).length}</span></div>
                </div>
            </div>);
        }
        
        function Perms({ps,saveP}){
            const rs=['supervisor','creador','mecanico'];
            const pm=[
                {k:'co',l:'Crear OT'},
                {k:'eo',l:'Editar OT'},
                {k:'do',l:'Eliminar OT'},
                {k:'cu',l:'Crear Usuarios'},
                {k:'eu',l:'Editar Usuarios'},
                {k:'du',l:'Eliminar Usuarios'},
                {k:'ei',l:'Editar Inventario'},
                {k:'ar',l:'A√±adir Repuesto'},
                {k:'cr',l:'Consumir Repuesto'},
                {k:'er',l:'Eliminar Repuesto'},
                {k:'pdf',l:'üìÑ Generar PDF'},
                {k:'imp',l:'üñ®Ô∏è Imprimir PDF'},
                {k:'arch',l:'üìÅ Acceder a Archivo OTs'},
                {k:'modpdf',l:'‚úèÔ∏è Modificar configuraci√≥n PDF'},
                {k:'ia',l:'ü§ñ Usar Asistente Robert (IA)'}
            ];
            const tog=(r,p)=>{if(r==='supervisor')return;saveP({...ps,[r]:{...ps[r],[p]:!ps[r][p]}})};
            return(<div style={{background:'#fff',borderRadius:'0.5rem',padding:'1.5rem'}}>
                <h2 style={{fontSize:'1.5rem',fontWeight:'bold',marginBottom:'1.5rem'}}>‚öôÔ∏è Permisos por Rol</h2>
                <div style={{overflowX:'auto'}}>
                    <table style={{width:'100%'}}>
                        <thead>
                            <tr>
                                <th style={{textAlign:'left',padding:'0.75rem',background:'#f9fafb',borderBottom:'2px solid #e5e7eb'}}>Permiso</th>
                                {rs.map(r=><th key={r} style={{textAlign:'center',textTransform:'capitalize',padding:'0.75rem',background:'#f9fafb',borderBottom:'2px solid #e5e7eb'}}>{r}</th>)}
                            </tr>
                        </thead>
                        <tbody>
                            {pm.map((p,i)=><tr key={p.k} style={{background:i%2===0?'#fff':'#f9fafb'}}>
                                <td style={{padding:'0.75rem',fontWeight:'600',color:'#374151'}}>{p.l}</td>
                                {rs.map(r=><td key={r} style={{textAlign:'center',padding:'0.75rem'}}>
                                    <input type="checkbox" checked={ps[r]?.[p.k]||false} onChange={()=>tog(r,p.k)} disabled={r==='supervisor'} style={{width:'20px',height:'20px',cursor:r==='supervisor'?'not-allowed':'pointer'}}/>
                                </td>)}
                            </tr>)}
                        </tbody>
                    </table>
                </div>
                <div style={{marginTop:'1rem',padding:'1rem',background:'#eff6ff',borderRadius:'0.5rem',border:'1px solid #bfdbfe'}}>
                    <p style={{fontSize:'0.875rem',color:'#1e40af',margin:0}}><strong>‚ÑπÔ∏è Nota:</strong> El supervisor tiene todos los permisos habilitados por defecto y no se pueden modificar.</p>
                </div>
            </div>);
        }
        
        
        // ü§ñ ROBERT - Asistente IA de Mantenimiento
        function RobertIA({os,inv,problema,setRespuesta}){
            const[analizando,setAnalizando]=useState(false);
            
            const analizarProblema=(descripcionProblema)=>{
                setAnalizando(true);
                
                // Simular an√°lisis (en producci√≥n ser√≠a llamada a API)
                setTimeout(()=>{
                    const analisis=generarAnalisisInteligente(descripcionProblema,os,inv);
                    setRespuesta(analisis);
                    setAnalizando(false);
                },1500);
            };
            
            const generarAnalisisInteligente=(problema,ordenes,inventario)=>{
                const palabrasClave=problema.toLowerCase().split(' ').filter(p=>p.length>3);
                
                // Buscar OTs similares resueltas
                const otsSimilares=ordenes.filter(o=>{
                    if(o.es!=='cerrada'&&o.es!=='registrada')return false;
                    const textoOT=(o.tr+' '+(o.trab||'')+' '+(o.ob||'')).toLowerCase();
                    return palabrasClave.some(palabra=>textoOT.includes(palabra));
                }).slice(0,5);
                
                // An√°lisis de repuestos m√°s usados en problemas similares
                const repuestosUsados={};
                otsSimilares.forEach(ot=>{
                    if(ot.rp){
                        ot.rp.forEach(rep=>{
                            if(!repuestosUsados[rep.nom])repuestosUsados[rep.nom]=0;
                            repuestosUsados[rep.nom]+=rep.cant;
                        });
                    }
                });
                
                // Ordenar repuestos por frecuencia
                const repuestosRecomendados=Object.entries(repuestosUsados)
                    .sort((a,b)=>b[1]-a[1])
                    .slice(0,5);
                
                // Buscar repuestos en inventario relacionados
                const repuestosDisponibles=inventario.filter(rep=>{
                    const nombreRep=rep.nombre.toLowerCase();
                    return palabrasClave.some(palabra=>nombreRep.includes(palabra));
                }).slice(0,5);
                
                // Extraer soluciones de OTs similares
                const soluciones=otsSimilares
                    .filter(ot=>ot.trab&&ot.trab.length>10)
                    .map(ot=>({
                        descripcion:ot.trab,
                        resultado:ot.re==='ok'?'‚úÖ Exitoso':'‚ö†Ô∏è Parcial',
                        repuestos:ot.rp?.map(r=>r.nom).join(', ')||'Ninguno',
                        tiempo:ot.in&&ot.fi?Math.round((new Date(ot.fi)-new Date(ot.in))/(1000*60*60))+'h':'N/A'
                    }));
                
                // Detectar categor√≠a del problema
                let categoria='General';
                let urgencia='Media';
                const problemaLower=problema.toLowerCase();
                
                if(problemaLower.includes('fuga')||problemaLower.includes('p√©rdida')||problemaLower.includes('perdida')){
                    categoria='Fugas y P√©rdidas';
                    urgencia='Alta';
                }else if(problemaLower.includes('ruido')||problemaLower.includes('vibra')){
                    categoria='Ruidos y Vibraciones';
                    urgencia='Media';
                }else if(problemaLower.includes('filtro')||problemaLower.includes('hepa')){
                    categoria='Filtraci√≥n';
                    urgencia='Alta';
                }else if(problemaLower.includes('bomba')||problemaLower.includes('motor')){
                    categoria='Equipos Mec√°nicos';
                    urgencia='Alta';
                }else if(problemaLower.includes('el√©ctrico')||problemaLower.includes('electrico')||problemaLower.includes('corriente')){
                    categoria='Sistemas El√©ctricos';
                    urgencia='Alta';
                }else if(problemaLower.includes('presi√≥n')||problemaLower.includes('presion')){
                    categoria='Sistemas de Presi√≥n';
                    urgencia='Alta';
                }else if(problemaLower.includes('temperatura')||problemaLower.includes('calor')||problemaLower.includes('fr√≠o')||problemaLower.includes('frio')){
                    categoria='Control de Temperatura';
                    urgencia='Media';
                }
                
                // Generar recomendaciones basadas en el hist√≥rico
                let recomendaciones=[];
                
                if(otsSimilares.length>0){
                    const tasaExito=otsSimilares.filter(o=>o.re==='ok').length/otsSimilares.length;
                    if(tasaExito>0.7){
                        recomendaciones.push('üìä Alta tasa de √©xito ('+Math.round(tasaExito*100)+'%) en problemas similares');
                    }
                    
                    const tiemposPromedio=otsSimilares.filter(o=>o.in&&o.fi).map(o=>(new Date(o.fi)-new Date(o.in))/(1000*60*60));
                    if(tiemposPromedio.length>0){
                        const promedio=tiemposPromedio.reduce((a,b)=>a+b,0)/tiemposPromedio.length;
                        recomendaciones.push('‚è±Ô∏è Tiempo estimado: '+Math.round(promedio)+'h (basado en '+tiemposPromedio.length+' casos)');
                    }
                }
                
                // Alertas de inventario
                const alertasInventario=[];
                repuestosRecomendados.forEach(([nombre,cant])=>{
                    const enInventario=inventario.find(i=>i.nombre.toLowerCase().includes(nombre.toLowerCase()));
                    if(enInventario){
                        if(enInventario.cantidad<cant){
                            alertasInventario.push('‚ö†Ô∏è '+nombre+': Stock insuficiente ('+enInventario.cantidad+'/'+cant+')');
                        }else{
                            alertasInventario.push('‚úÖ '+nombre+': Disponible ('+enInventario.cantidad+' en stock)');
                        }
                    }else{
                        alertasInventario.push('‚ùå '+nombre+': No en inventario');
                    }
                });
                
                return{
                    problema,
                    categoria,
                    urgencia,
                    otsSimilares:otsSimilares.length,
                    soluciones,
                    repuestosRecomendados:repuestosRecomendados.map(([nom,cant])=>({nombre:nom,cantidad:cant})),
                    repuestosDisponibles,
                    recomendaciones,
                    alertasInventario,
                    confianza:otsSimilares.length>2?'Alta':(otsSimilares.length>0?'Media':'Baja')
                };
            };
            
            return null; // Componente l√≥gico, sin UI propia
        }
        
        function Modal({m,setM,us,saveU,os,saveO,u,hp,inv}){
            if(m.t==='u')return <UMod m={m} setM={setM} us={us} saveU={saveU} hp={hp}/>;
            if(m.t==='o')return <OMod m={m} setM={setM} us={us} os={os} saveO={saveO} u={u} hp={hp} inv={inv}/>;
            if(m.t==='c')return <CMod m={m} setM={setM} os={os} saveO={saveO} us={us}/>;
            if(m.t==='v')return <VMod m={m} setM={setM} us={us} os={os} saveO={saveO} hp={hp}/>;
            if(m.t==='rep')return <RepMod m={m} setM={setM} inv={inv}/>;
            if(m.t==='prog')return <ProgMod m={m} setM={setM} os={os} saveO={saveO} inv={inv} u={u}/>;
        }
        
        function UMod({m,setM,us,saveU,hp}){
            const[f,setF]=useState(m.d||{username:'',password:'',name:'',role:'mecanico',email:'',tel:''});
            const save=()=>{if(!f.username||!f.name)return alert('Complete campos');if(m.d){if(!hp('eu'))return alert('Sin permiso');saveU(us.map(x=>x.id===m.d.id?{...f,id:m.d.id}:x))}else{if(!hp('cu'))return alert('Sin permiso');if(!f.password)return alert('Password requerido');saveU([...us,{...f,id:Date.now()}])}setM(null)};
            return(<div style={{position:'fixed',inset:0,background:'rgba(0,0,0,0.5)',display:'flex',alignItems:'center',justifyContent:'center',padding:'1rem',zIndex:50}} onClick={()=>setM(null)}>
                <div style={{background:'#fff',borderRadius:'0.5rem',padding:'1.5rem',width:'100%',maxWidth:'500px'}} onClick={e=>e.stopPropagation()}>
                    <h2 style={{marginBottom:'1rem',fontSize:'1.5rem',fontWeight:'bold'}}>{m.d?'Editar':'Nuevo'} Usuario</h2>
                    <input type="text" placeholder="Nombre" value={f.name} onChange={e=>setF({...f,name:e.target.value})}/>
                    <input type="text" placeholder="Usuario" value={f.username} onChange={e=>setF({...f,username:e.target.value})}/>
                    <input type="email" placeholder="Email" value={f.email} onChange={e=>setF({...f,email:e.target.value})}/>
                    <label style={{display:'block',fontSize:'0.875rem',marginBottom:'0.25rem',fontWeight:'600',color:'#374151'}}>Tel√©fono (con c√≥digo de pa√≠s)</label>
                    <input type="tel" placeholder="Ej: 34600123456 (Espa√±a) o 5215512345678 (M√©xico)" value={f.tel} onChange={e=>setF({...f,tel:e.target.value})} style={{marginBottom:'0.25rem'}}/>
                    <p style={{fontSize:'0.75rem',color:'#6b7280',marginBottom:'0.75rem',marginTop:0}}>üì± Formato: c√≥digo pa√≠s + n√∫mero (sin espacios, sin +)</p>
                    <input type="password" placeholder="Contrase√±a" value={f.password} onChange={e=>setF({...f,password:e.target.value})}/>
                    <select value={f.role} onChange={e=>setF({...f,role:e.target.value})}><option value="supervisor">Supervisor</option><option value="creador">Creador</option><option value="mecanico">Mec√°nico</option></select>
                    <div style={{display:'flex',gap:'0.5rem'}}><button onClick={save} className="btn bp" style={{flex:1}}>Guardar</button><button onClick={()=>setM(null)} className="btn bg" style={{flex:1}}>Cancelar</button></div>
                </div>
            </div>);
        }
        
        function OMod({m,setM,us,os,saveO,u,hp,inv}){
            const[f,setF]=useState(m.d||{n:'OT-'+Date.now(),aa:'',tr:'',ti:'preventivo',es:'creada',in:'',fi:'',dl:'',ob:'',re:'',rp:[],trab:'',prioridad:'auto',progreso:[]});
            const[nr,setNr]=useState({nom:'',cant:''});
            const[showRepSel,setShowRepSel]=useState(false);
            const[showRobert,setShowRobert]=useState(false);
            const[robertAnalisis,setRobertAnalisis]=useState(null);
            const[robertAnalizando,setRobertAnalizando]=useState(false);
            const isMec=u.role==='mecanico';
            
            // ü§ñ Funci√≥n de Robert IA
            const consultarRobert=()=>{
                if(!f.tr||f.tr.length<10){
                    alert('‚ö†Ô∏è Escribe una descripci√≥n m√°s detallada del problema (m√≠nimo 10 caracteres)');
                    return;
                }
                
                setRobertAnalizando(true);
                setShowRobert(true);
                
                // Simular an√°lisis
                setTimeout(()=>{
                    const analisis=generarAnalisisRobert(f.tr,f.ti,os,inv);
                    setRobertAnalisis(analisis);
                    setRobertAnalizando(false);
                },1500);
            };
            
            const generarAnalisisRobert=(descripcion,tipo,ordenes,inventario)=>{
                const palabrasClave=descripcion.toLowerCase().split(' ').filter(p=>p.length>3);
                
                // Buscar OTs similares
                const otsSimilares=ordenes.filter(o=>{
                    if(o.es!=='cerrada'&&o.es!=='registrada')return false;
                    if(tipo!=='correctivo'&&o.ti!==tipo)return false;
                    const textoOT=(o.tr+' '+(o.trab||'')).toLowerCase();
                    return palabrasClave.some(palabra=>textoOT.includes(palabra));
                }).slice(0,8);
                
                // Repuestos m√°s usados
                const repuestosUsados={};
                otsSimilares.forEach(ot=>{
                    if(ot.rp){
                        ot.rp.forEach(rep=>{
                            if(!repuestosUsados[rep.nom])repuestosUsados[rep.nom]=0;
                            repuestosUsados[rep.nom]+=rep.cant;
                        });
                    }
                });
                
                const repuestosRecomendados=Object.entries(repuestosUsados)
                    .sort((a,b)=>b[1]-a[1])
                    .slice(0,8);
                
                // Soluciones exitosas
                const soluciones=otsSimilares
                    .filter(ot=>ot.trab&&ot.re==='ok')
                    .map(ot=>({
                        numero:ot.n,
                        problema:ot.tr,
                        solucion:ot.trab,
                        repuestos:ot.rp?.length||0,
                        tiempo:ot.in&&ot.fi?Math.round((new Date(ot.fi)-new Date(ot.in))/(1000*60*60))+'h':'N/A',
                        mecanico:ot.aa
                    }))
                    .slice(0,5);
                
                // Categor√≠a y urgencia
                let categoria='General';
                let urgencia='Media';
                const descLower=descripcion.toLowerCase();
                
                if(descLower.includes('fuga')||descLower.includes('p√©rdida')||descLower.includes('perdida')||descLower.includes('goteo')){
                    categoria='üî¥ Fugas y P√©rdidas';
                    urgencia='Alta';
                }else if(descLower.includes('ruido')||descLower.includes('vibra')||descLower.includes('golpeteo')){
                    categoria='üîä Ruidos y Vibraciones';
                    urgencia='Media';
                }else if(descLower.includes('filtro')||descLower.includes('hepa')||descLower.includes('aire')){
                    categoria='üå¨Ô∏è Filtraci√≥n y Aire';
                    urgencia='Alta';
                }else if(descLower.includes('bomba')||descLower.includes('motor')||descLower.includes('compresor')){
                    categoria='‚öôÔ∏è Equipos Mec√°nicos';
                    urgencia='Alta';
                }else if(descLower.includes('el√©ctrico')||descLower.includes('electrico')||descLower.includes('corriente')||descLower.includes('cable')){
                    categoria='‚ö° Sistemas El√©ctricos';
                    urgencia='Alta';
                }else if(descLower.includes('presi√≥n')||descLower.includes('presion')||descLower.includes('psi')){
                    categoria='üí® Sistemas de Presi√≥n';
                    urgencia='Alta';
                }else if(descLower.includes('temperatura')||descLower.includes('calor')||descLower.includes('fr√≠o')||descLower.includes('frio')){
                    categoria='üå°Ô∏è Control de Temperatura';
                    urgencia='Media';
                }else if(descLower.includes('v√°lvula')||descLower.includes('valvula')||descLower.includes('llave')){
                    categoria='üîß V√°lvulas y Controles';
                    urgencia='Media';
                }else if(descLower.includes('sello')||descLower.includes('junta')||descLower.includes('empaque')){
                    categoria='üî© Sellos y Juntas';
                    urgencia='Alta';
                }
                
                // Recomendaciones inteligentes
                const recomendaciones=[];
                
                if(otsSimilares.length>0){
                    const tasaExito=otsSimilares.filter(o=>o.re==='ok').length/otsSimilares.length;
                    recomendaciones.push({
                        icono:'üìä',
                        texto:'Casos similares encontrados: '+otsSimilares.length,
                        tipo:'info'
                    });
                    recomendaciones.push({
                        icono:tasaExito>0.7?'‚úÖ':'‚ö†Ô∏è',
                        texto:'Tasa de √©xito: '+Math.round(tasaExito*100)+'%',
                        tipo:tasaExito>0.7?'success':'warning'
                    });
                    
                    const tiemposPromedio=otsSimilares.filter(o=>o.in&&o.fi).map(o=>(new Date(o.fi)-new Date(o.in))/(1000*60*60));
                    if(tiemposPromedio.length>0){
                        const promedio=Math.round(tiemposPromedio.reduce((a,b)=>a+b,0)/tiemposPromedio.length);
                        recomendaciones.push({
                            icono:'‚è±Ô∏è',
                            texto:'Tiempo estimado: '+promedio+'h',
                            tipo:'info'
                        });
                    }
                }else{
                    recomendaciones.push({
                        icono:'üÜï',
                        texto:'Problema nuevo - No hay casos similares en el historial',
                        tipo:'warning'
                    });
                }
                
                // Verificar inventario
                const alertasInventario=[];
                repuestosRecomendados.forEach(([nombre,cantUsada])=>{
                    const enInventario=inventario.find(i=>i.nombre.toLowerCase()===nombre.toLowerCase()||i.nombre.toLowerCase().includes(nombre.toLowerCase().substring(0,10)));
                    if(enInventario){
                        if(enInventario.cantidad>=cantUsada){
                            alertasInventario.push({
                                icono:'‚úÖ',
                                repuesto:nombre,
                                texto:'Disponible ('+enInventario.cantidad+' en stock)',
                                tipo:'success'
                            });
                        }else if(enInventario.cantidad>0){
                            alertasInventario.push({
                                icono:'‚ö†Ô∏è',
                                repuesto:nombre,
                                texto:'Stock bajo ('+enInventario.cantidad+'/'+cantUsada+' requeridos)',
                                tipo:'warning'
                            });
                        }else{
                            alertasInventario.push({
                                icono:'‚ùå',
                                repuesto:nombre,
                                texto:'Sin stock',
                                tipo:'error'
                            });
                        }
                    }else{
                        alertasInventario.push({
                            icono:'‚ùì',
                            repuesto:nombre,
                            texto:'No encontrado en inventario',
                            tipo:'warning'
                        });
                    }
                });
                
                return{
                    problema:descripcion,
                    categoria,
                    urgencia,
                    confianza:otsSimilares.length>3?'Alta':(otsSimilares.length>0?'Media':'Baja'),
                    otsSimilares:otsSimilares.length,
                    soluciones,
                    repuestosRecomendados:repuestosRecomendados.map(([nom,cant])=>({nombre:nom,cantidad:cant})),
                    recomendaciones,
                    alertasInventario
                };
            };
            
            const aplicarSolucion=(solucion)=>{
                if(confirm('¬øAplicar esta soluci√≥n como referencia?\n\nSe copiar√° en Observaciones para tu consulta.')){
                    setF({...f,ob:(f.ob?f.ob+'\n\n':'')+'üí° Soluci√≥n de '+solucion.numero+':\n'+solucion.solucion});
                    alert('‚úÖ Soluci√≥n agregada a Observaciones');
                }
            };
            
            const agregarRepuesto=(nombreRep)=>{
                const repEnInventario=inv.find(i=>i.nombre.toLowerCase()===nombreRep.toLowerCase()||i.nombre.toLowerCase().includes(nombreRep.toLowerCase()));
                if(repEnInventario){
                    setNr({nom:repEnInventario.nombre,cant:'1'});
                    alert('‚úÖ Repuesto agregado al formulario. Ajusta la cantidad si es necesario.');
                }else{
                    setNr({nom:nombreRep,cant:'1'});
                    alert('‚ö†Ô∏è Repuesto agregado pero no est√° en el inventario. Agr√©galo manualmente.');
                }
            };
            
            // Funciones auxiliares para turnos
            const getTurnoActual=()=>{
                const ahora=new Date();
                const hora=ahora.getHours();
                if(hora>=6&&hora<14)return {nombre:'ma√±ana',inicio:6,fin:14};
                if(hora>=14&&hora<22)return {nombre:'tarde',inicio:14,fin:22};
                return {nombre:'noche',inicio:22,fin:6}; // 22:00 a 06:00
            };
            
            const getFinDeTurno=()=>{
                const ahora=new Date();
                const turno=getTurnoActual();
                const finTurno=new Date(ahora);
                
                if(turno.nombre==='noche'){
                    // Si es noche (22-06), el fin es a las 06:00 del d√≠a siguiente
                    finTurno.setDate(finTurno.getDate()+1);
                    finTurno.setHours(6,0,0,0);
                }else{
                    // Para ma√±ana y tarde, el fin es el mismo d√≠a
                    finTurno.setHours(turno.fin,0,0,0);
                }
                return finTurno;
            };
            
            const getFinDeDia=()=>{
                const ahora=new Date();
                const finDia=new Date(ahora);
                finDia.setHours(23,59,59,999);
                return finDia;
            };
            
            // Calcular urgente e importante autom√°ticamente basado en deadline y turnos
            const calcularPrioridad=()=>{
                if(f.prioridad!=='auto')return; // Si es manual, no calcular
                if(!f.dl)return {urgente:false,importante:false};
                
                const ahora=new Date();
                const deadline=new Date(f.dl);
                const horasRestantes=(deadline-ahora)/(1000*60*60);
                
                // Si est√° vencida
                if(horasRestantes<0)return {urgente:true,importante:true};
                
                const finTurno=getFinDeTurno();
                const finDia=getFinDeDia();
                const en72horas=new Date(ahora.getTime()+72*60*60*1000);
                
                // üî¥ URGENTE E IMPORTANTE: Antes del fin de turno
                if(deadline<=finTurno)return {urgente:true,importante:true};
                
                // üü° IMPORTANTE (NO URGENTE): Antes del fin del d√≠a
                if(deadline<=finDia)return {urgente:false,importante:true};
                
                // üü† URGENTE (NO IMPORTANTE): Dentro de 72 horas
                if(deadline<=en72horas)return {urgente:true,importante:false};
                
                // üü¢ NO URGENTE NI IMPORTANTE: M√°s de 72 horas (se establece manual)
                return {urgente:false,importante:false};
            };
            
            const getPrioridadFromDropdown=()=>{
                switch(f.prioridad){
                    case 'hacer_ya':return {urgente:true,importante:true};
                    case 'planificar':return {urgente:false,importante:true};
                    case 'delegar':return {urgente:true,importante:false};
                    case 'revisar':return {urgente:false,importante:false};
                    default:return calcularPrioridad(); // 'auto'
                }
            };
            const save=()=>{
                if(!f.aa||!f.tr||!f.n)return alert('Complete campos');
                const prioridad=getPrioridadFromDropdown();
                const dataToSave={...f,urgente:prioridad.urgente,importante:prioridad.importante};
                
                if(m.d){
                    if(!hp('eo'))return alert('Sin permiso');
                    saveO(os.map(x=>x.id===m.d.id?{...dataToSave,id:m.d.id}:x));
                }else{
                    if(!hp('co'))return alert('Sin permiso');
                    saveO([...os,{...dataToSave,id:Date.now(),creadoPor:u.name}]);
                    const t=us.find(x=>x.name===f.aa)?.tel;
                    if(t){
                        const tel=t.replace(/\D/g,'');
                        const msg=`üîß *NUEVA ORDEN DE TRABAJO*\n\nüìã *N¬∫:* ${f.n}\nüë§ *Asignado a:* ${f.aa}\nüìù *Trabajo:* ${f.tr}\n‚è∞ *Deadline:* ${f.dl?new Date(f.dl).toLocaleString('es-ES'):'No definido'}`;
                        window.open(`https://wa.me/${tel}?text=${encodeURIComponent(msg)}`,'_blank');
                    }
                }
                setM(null);
            };
            const addR=()=>{if(nr.nom&&nr.cant){setF({...f,rp:[...f.rp,{...nr,id:Date.now()}]});setNr({nom:'',cant:''})}};
            const delR=(id)=>setF({...f,rp:f.rp.filter(x=>x.id!==id)});
            return(<div style={{position:'fixed',inset:0,background:'rgba(0,0,0,0.5)',display:'flex',alignItems:'center',justifyContent:'center',padding:'1rem',zIndex:50,overflowY:'auto'}} onClick={()=>setM(null)}>
                <div style={{background:'#fff',borderRadius:'0.5rem',padding:'1.5rem',width:'100%',maxWidth:'600px',margin:'2rem 0'}} onClick={e=>e.stopPropagation()}>
                    <h2 style={{marginBottom:'1rem',fontSize:'1.5rem',fontWeight:'bold'}}>{m.d?'Editar':'Nueva'} Orden</h2>
                    
                    {!isMec&&<><label style={{display:'block',fontSize:'0.875rem',marginBottom:'0.25rem',fontWeight:'600'}}>N√∫mero OT</label>
                    <input type="text" value={f.n} onChange={e=>setF({...f,n:e.target.value})}/></>}
                    
                    {!isMec&&<><label style={{display:'block',fontSize:'0.875rem',marginBottom:'0.25rem',fontWeight:'600'}}>Asignar</label>
                    <select value={f.aa} onChange={e=>setF({...f,aa:e.target.value})}><option value="">Seleccionar...</option>{us.filter(x=>x.role==='mecanico').map(x=><option key={x.id} value={x.name}>{x.name}</option>)}</select></>}
                    
                    {!isMec&&<><label style={{display:'block',fontSize:'0.875rem',marginBottom:'0.25rem',fontWeight:'600'}}>Trabajo</label>
                    <textarea value={f.tr} onChange={e=>setF({...f,tr:e.target.value})} style={{minHeight:'80px'}} placeholder="Describe el problema o trabajo a realizar..."/>
                    {hp('ia')&&f.tr.length>10&&!showRobert&&<button type="button" onClick={consultarRobert} className="btn" style={{background:'linear-gradient(135deg,#8b5cf6,#7c3aed)',color:'#fff',width:'100%',marginTop:'0.5rem',display:'flex',alignItems:'center',justifyContent:'center',gap:'0.5rem',boxShadow:'0 4px 6px rgba(139,92,246,0.3)'}}>ü§ñ Consultar a Robert (IA)</button>}
                    </>}
                    
                    {!isMec&&<select value={f.ti} onChange={e=>setF({...f,ti:e.target.value})}><option value="preventivo">Preventivo</option><option value="correctivo">Correctivo</option><option value="predictivo">Predictivo</option><option value="emergencia">Emergencia</option></select>}
                    
                    {!isMec&&<select value={f.es} onChange={e=>setF({...f,es:e.target.value})}>
                        <option value="creada">Creada</option>
                        <option value="haciendo">Haciendo</option>
                        <option value="hecha">Hecha</option>
                        {u.role==='supervisor'&&<option value="registrada">Registrada</option>}
                        {u.role==='supervisor'&&<option value="cerrada">Cerrada</option>}
                    </select>}
                    
                    {!isMec&&<><label style={{display:'block',fontSize:'0.875rem',marginBottom:'0.25rem',fontWeight:'600'}}>Inicio</label>
                    <input type="datetime-local" value={f.in} onChange={e=>setF({...f,in:e.target.value})}/></>}
                    
                    {!isMec&&<><label style={{display:'block',fontSize:'0.875rem',marginBottom:'0.25rem',fontWeight:'600'}}>Deadline</label>
                    <input type="datetime-local" value={f.dl} onChange={e=>setF({...f,dl:e.target.value})}/></>}
                    
                    {!isMec&&<div style={{background:'#f0f9ff',padding:'1rem',borderRadius:'0.5rem',marginBottom:'1rem',border:'2px solid #3b82f6'}}>
                        {(()=>{
                            const turno=getTurnoActual();
                            const finTurno=getFinDeTurno();
                            const ahora=new Date();
                            const horasHastaFin=((finTurno-ahora)/(1000*60*60)).toFixed(1);
                            const iconos={ma√±ana:'‚òÄÔ∏è',tarde:'üå§Ô∏è',noche:'üåô'};
                            return(<>
                                <div style={{display:'flex',alignItems:'center',gap:'0.5rem',marginBottom:'0.5rem'}}>
                                    <span style={{fontSize:'1.5rem'}}>{iconos[turno.nombre]}</span>
                                    <div>
                                        <div style={{fontSize:'0.875rem',fontWeight:'700',color:'#1e40af'}}>Turno actual: {turno.nombre.toUpperCase()}</div>
                                        <div style={{fontSize:'0.75rem',color:'#3b82f6'}}>Horario: {String(turno.inicio).padStart(2,'0')}:00 - {String(turno.fin).padStart(2,'0')}:00</div>
                                    </div>
                                </div>
                                <div style={{fontSize:'0.75rem',color:'#1e40af',fontWeight:'600'}}>
                                    ‚è∞ Quedan {horasHastaFin}h para fin de turno
                                </div>
                            </>);
                        })()}
                    </div>}
                    
                    {!isMec&&<div style={{marginBottom:'1rem',padding:'1rem',background:'#f9fafb',borderRadius:'0.5rem',border:'1px solid #e5e7eb'}}>
                        <label style={{display:'block',fontSize:'0.875rem',marginBottom:'0.75rem',fontWeight:'700',color:'#111827'}}>üéØ Prioridad de la Orden</label>
                        
                        <select value={f.prioridad||'auto'} onChange={e=>setF({...f,prioridad:e.target.value})} style={{marginBottom:'0.75rem'}}>
                            <option value="auto">‚ö° Autom√°tico (seg√∫n deadline y turno)</option>
                            <option value="hacer_ya">üî¥ Hacer YA (Antes fin turno)</option>
                            <option value="planificar">üü° Planificar (Antes fin d√≠a)</option>
                            <option value="delegar">üü† Delegar (72h)</option>
                            <option value="revisar">üü¢ Revisar (Manual)</option>
                        </select>
                        
                        {(()=>{
                            const prioActual=getPrioridadFromDropdown();
                            const getBadge=()=>{
                                if(prioActual.urgente&&prioActual.importante)return {bg:'#fee2e2',color:'#991b1b',text:'üî¥ Hacer YA',desc:'Antes fin de turno'};
                                if(prioActual.urgente&&!prioActual.importante)return {bg:'#fed7aa',color:'#9a3412',text:'üü† Delegar',desc:'Dentro de 72h'};
                                if(!prioActual.urgente&&prioActual.importante)return {bg:'#fef3c7',color:'#92400e',text:'üü° Planificar',desc:'Antes fin de d√≠a'};
                                return {bg:'#d1fae5',color:'#065f46',text:'üü¢ Revisar',desc:'Manual / >72h'};
                            };
                            const badge=getBadge();
                            
                            return(<div style={{padding:'0.75rem',background:badge.bg,borderRadius:'0.5rem',border:`2px solid ${badge.color}33`}}>
                                <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:'0.5rem'}}>
                                    <span style={{fontSize:'0.875rem',fontWeight:'700',color:badge.color}}>{badge.text}</span>
                                    <span style={{fontSize:'0.75rem',color:badge.color,opacity:0.8}}>{badge.desc}</span>
                                </div>
                                {f.prioridad==='auto'&&f.dl&&<div style={{fontSize:'0.75rem',color:badge.color,opacity:0.9,fontStyle:'italic'}}>
                                    {(()=>{
                                        const ahora=new Date();
                                        const deadline=new Date(f.dl);
                                        const horasRestantes=((deadline-ahora)/(1000*60*60)).toFixed(1);
                                        const turnoActual=getTurnoActual();
                                        const finTurno=getFinDeTurno();
                                        const finDia=getFinDeDia();
                                        
                                        if(horasRestantes<0)return `‚ö†Ô∏è Vencida (hace ${Math.abs(horasRestantes)}h)`;
                                        
                                        const horasHastaFinTurno=((finTurno-ahora)/(1000*60*60)).toFixed(1);
                                        const horasHastaFinDia=((finDia-ahora)/(1000*60*60)).toFixed(1);
                                        
                                        if(deadline<=finTurno)return `üî¥ ${horasRestantes}h (Turno ${turnoActual.nombre} termina en ${horasHastaFinTurno}h)`;
                                        if(deadline<=finDia)return `üü° ${horasRestantes}h (D√≠a termina en ${horasHastaFinDia}h)`;
                                        if(horasRestantes<=72)return `üü† ${horasRestantes}h (Dentro de 72h)`;
                                        return `üü¢ ${horasRestantes}h (M√°s de 72h)`;
                                    })()}
                                </div>}
                                {f.prioridad==='auto'&&!f.dl&&<div style={{fontSize:'0.75rem',color:badge.color,opacity:0.9,fontStyle:'italic'}}>
                                    ‚ÑπÔ∏è Establece un deadline para c√°lculo autom√°tico
                                </div>}
                                {f.prioridad!=='auto'&&<div style={{fontSize:'0.75rem',color:badge.color,opacity:0.9,fontStyle:'italic'}}>
                                    ‚úã Prioridad manual establecida por el creador
                                </div>}
                            </div>);
                        })()}
                    </div>}
                    
                    {isMec&&<div style={{background:'#dbeafe',padding:'1rem',borderRadius:'0.5rem',marginBottom:'1rem',borderLeft:'4px solid #2563eb'}}>
                        <p style={{fontWeight:'600',color:'#1e40af'}}>OT: {f.n}</p>
                        <p style={{fontSize:'0.875rem',color:'#1e40af'}}>Trabajo: {f.tr}</p>
                    </div>}
                    
                    {isMec&&<><label style={{display:'block',fontSize:'0.875rem',marginBottom:'0.25rem',fontWeight:'600'}}>Trabajos Realizados</label>
                    <textarea placeholder="Describe los trabajos realizados..." value={f.trab} onChange={e=>setF({...f,trab:e.target.value})} style={{minHeight:'100px'}}/></>}
                    
                    {isMec&&<><label style={{display:'block',fontSize:'0.875rem',marginBottom:'0.25rem',fontWeight:'600'}}>Repuestos Usados</label>
                    {f.rp?.map(r=><div key={r.id} style={{display:'flex',alignItems:'center',gap:'0.5rem',background:'#f3f4f6',padding:'0.5rem',borderRadius:'0.375rem',marginBottom:'0.5rem'}}>
                        <span style={{flex:1}}>üî© {r.nom} - {r.cant}u</span>
                        <button onClick={()=>delR(r.id)} style={{border:'none',background:'none',cursor:'pointer',color:'#ef4444'}}>üóëÔ∏è</button>
                    </div>)}
                    <div style={{display:'flex',gap:'0.5rem',marginBottom:'0.75rem'}}>
                        <button onClick={()=>setShowRepSel(!showRepSel)} style={{background:'#2563eb',color:'#fff',border:'none',borderRadius:'0.375rem',padding:'0.5rem 1rem',cursor:'pointer',flex:1}}>üì¶ Seleccionar del Inventario</button>
                        <button onClick={()=>setNr({nom:'MANUAL',cant:''})} style={{background:'#6b7280',color:'#fff',border:'none',borderRadius:'0.375rem',padding:'0.5rem 1rem',cursor:'pointer'}}>‚úèÔ∏è Manual</button>
                    </div>
                    {showRepSel&&<div style={{maxHeight:'300px',overflowY:'auto',border:'1px solid #e5e7eb',borderRadius:'0.375rem',marginBottom:'0.75rem'}}>
                        <table style={{width:'100%',fontSize:'0.875rem'}}>
                            <thead style={{position:'sticky',top:0,background:'#f9fafb'}}>
                                <tr><th>C√≥digo</th><th>Nombre</th><th>Stock</th><th></th></tr>
                            </thead>
                            <tbody>
                                {inv?.map(item=><tr key={item.id} style={{borderBottom:'1px solid #e5e7eb'}}>
                                    <td style={{padding:'0.5rem',fontFamily:'monospace',fontSize:'0.75rem'}}>{item.codigo}</td>
                                    <td style={{padding:'0.5rem'}}>{item.nombre}</td>
                                    <td style={{padding:'0.5rem',textAlign:'center'}}>{item.cantidad}</td>
                                    <td style={{padding:'0.5rem',textAlign:'center'}}>
                                        <button onClick={()=>{const cant=prompt(`Cantidad de "${item.nombre}" usada:`);if(cant){setF({...f,rp:[...f.rp,{id:Date.now(),nom:item.nombre,cant:parseInt(cant)||1,codigo:item.codigo}]});setShowRepSel(false)}}} style={{background:'#10b981',color:'#fff',border:'none',borderRadius:'0.25rem',padding:'0.25rem 0.5rem',cursor:'pointer',fontSize:'0.75rem'}}>+ Agregar</button>
                                    </td>
                                </tr>)}
                            </tbody>
                        </table>
                    </div>}
                    {nr.nom==='MANUAL'&&<div style={{display:'grid',gridTemplateColumns:'1fr 1fr auto',gap:'0.5rem',marginBottom:'0.75rem'}}>
                        <input type="text" placeholder="Nombre repuesto" value={nr.nom==='MANUAL'?'':nr.nom} onChange={e=>setNr({...nr,nom:e.target.value})} style={{marginBottom:0}}/>
                        <input type="number" placeholder="Cantidad" value={nr.cant} onChange={e=>setNr({...nr,cant:e.target.value})} style={{marginBottom:0}}/>
                        <button onClick={()=>{addR();setNr({nom:'',cant:''})}} style={{background:'#10b981',color:'#fff',border:'none',borderRadius:'0.375rem',padding:'0.5rem 1rem',cursor:'pointer'}}>+</button>
                    </div>}</>}
                    
                    {!isMec&&<><label style={{display:'block',fontSize:'0.875rem',marginBottom:'0.25rem',fontWeight:'600'}}>Observaciones</label>
                    <textarea value={f.ob} onChange={e=>setF({...f,ob:e.target.value})} style={{minHeight:'60px'}}/></>}
                    
                    {isMec&&<><label style={{display:'block',fontSize:'0.875rem',marginBottom:'0.25rem',fontWeight:'600'}}>Observaciones</label>
                    <textarea placeholder="Observaciones adicionales..." value={f.ob} onChange={e=>setF({...f,ob:e.target.value})} style={{minHeight:'60px'}}/></>}
                    
                    {/* ü§ñ Panel de Robert IA */}
                    {showRobert&&<div style={{background:'linear-gradient(135deg,#f3e8ff,#faf5ff)',border:'2px solid #8b5cf6',borderRadius:'0.75rem',padding:'1.5rem',marginTop:'1rem',boxShadow:'0 4px 6px rgba(139,92,246,0.2)'}}>
                        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'1rem'}}>
                            <h3 style={{fontSize:'1.25rem',fontWeight:'bold',color:'#6b21a8',display:'flex',alignItems:'center',gap:'0.5rem',margin:0}}>
                                ü§ñ Robert - Asistente IA
                            </h3>
                            <button onClick={()=>setShowRobert(false)} style={{border:'none',background:'rgba(107,33,168,0.1)',color:'#6b21a8',cursor:'pointer',padding:'0.25rem 0.5rem',borderRadius:'0.25rem',fontSize:'0.875rem'}}>‚úñ Cerrar</button>
                        </div>
                        
                        {robertAnalizando?<div style={{textAlign:'center',padding:'2rem'}}>
                            <div style={{fontSize:'2rem',marginBottom:'1rem'}}>üîÑ</div>
                            <p style={{color:'#7c3aed',fontWeight:'600'}}>Analizando casos similares en el historial...</p>
                        </div>:<>
                            {robertAnalisis&&<>
                                {/* Header del an√°lisis */}
                                <div style={{background:'rgba(255,255,255,0.7)',padding:'1rem',borderRadius:'0.5rem',marginBottom:'1rem'}}>
                                    <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(150px,1fr))',gap:'1rem',marginBottom:'1rem'}}>
                                        <div>
                                            <p style={{fontSize:'0.75rem',color:'#7c3aed',fontWeight:'600',marginBottom:'0.25rem'}}>CATEGOR√çA</p>
                                            <p style={{fontSize:'0.95rem',fontWeight:'700',color:'#6b21a8',margin:0}}>{robertAnalisis.categoria}</p>
                                        </div>
                                        <div>
                                            <p style={{fontSize:'0.75rem',color:'#7c3aed',fontWeight:'600',marginBottom:'0.25rem'}}>URGENCIA</p>
                                            <span style={{padding:'0.25rem 0.75rem',background:robertAnalisis.urgencia==='Alta'?'#fee2e2':'#fef3c7',color:robertAnalisis.urgencia==='Alta'?'#991b1b':'#92400e',borderRadius:'999px',fontSize:'0.875rem',fontWeight:'700'}}>{robertAnalisis.urgencia}</span>
                                        </div>
                                        <div>
                                            <p style={{fontSize:'0.75rem',color:'#7c3aed',fontWeight:'600',marginBottom:'0.25rem'}}>CASOS SIMILARES</p>
                                            <p style={{fontSize:'1.25rem',fontWeight:'700',color:'#6b21a8',margin:0}}>{robertAnalisis.otsSimilares}</p>
                                        </div>
                                        <div>
                                            <p style={{fontSize:'0.75rem',color:'#7c3aed',fontWeight:'600',marginBottom:'0.25rem'}}>CONFIANZA</p>
                                            <span style={{padding:'0.25rem 0.75rem',background:robertAnalisis.confianza==='Alta'?'#d1fae5':'#fef3c7',color:robertAnalisis.confianza==='Alta'?'#065f46':'#92400e',borderRadius:'999px',fontSize:'0.875rem',fontWeight:'700'}}>{robertAnalisis.confianza}</span>
                                        </div>
                                    </div>
                                    
                                    {/* Recomendaciones generales */}
                                    {robertAnalisis.recomendaciones.length>0&&<div style={{marginTop:'1rem'}}>
                                        {robertAnalisis.recomendaciones.map((rec,i)=><div key={i} style={{display:'flex',gap:'0.5rem',alignItems:'center',padding:'0.5rem',background:rec.tipo==='success'?'rgba(16,185,129,0.1)':rec.tipo==='warning'?'rgba(245,158,11,0.1)':'rgba(59,130,246,0.1)',borderRadius:'0.25rem',marginBottom:'0.5rem'}}>
                                            <span style={{fontSize:'1.25rem'}}>{rec.icono}</span>
                                            <span style={{fontSize:'0.875rem',fontWeight:'600',color:'#374151'}}>{rec.texto}</span>
                                        </div>)}
                                    </div>}
                                </div>
                                
                                {/* Soluciones anteriores */}
                                {robertAnalisis.soluciones.length>0&&<div style={{marginBottom:'1rem'}}>
                                    <h4 style={{fontSize:'1rem',fontWeight:'700',color:'#6b21a8',marginBottom:'0.75rem',display:'flex',alignItems:'center',gap:'0.5rem'}}>
                                        üí° Soluciones Exitosas Anteriores
                                    </h4>
                                    <div style={{maxHeight:'300px',overflowY:'auto'}}>
                                        {robertAnalisis.soluciones.map((sol,i)=><div key={i} style={{background:'white',padding:'1rem',borderRadius:'0.5rem',marginBottom:'0.75rem',border:'1px solid #e9d5ff'}}>
                                            <div style={{display:'flex',justifyContent:'space-between',alignItems:'start',marginBottom:'0.5rem'}}>
                                                <div>
                                                    <span style={{fontSize:'0.875rem',fontWeight:'700',color:'#2563eb'}}>{sol.numero}</span>
                                                    <span style={{fontSize:'0.75rem',color:'#6b7280',marginLeft:'0.5rem'}}>por {sol.mecanico}</span>
                                                </div>
                                                <div style={{display:'flex',gap:'0.5rem',fontSize:'0.75rem',color:'#6b7280'}}>
                                                    <span>‚è±Ô∏è {sol.tiempo}</span>
                                                    <span>üî© {sol.repuestos} rep.</span>
                                                </div>
                                            </div>
                                            <p style={{fontSize:'0.875rem',color:'#4b5563',marginBottom:'0.5rem',fontStyle:'italic'}}>"{sol.problema.substring(0,100)}{sol.problema.length>100?'...':''}"</p>
                                            <p style={{fontSize:'0.875rem',color:'#065f46',background:'#d1fae5',padding:'0.5rem',borderRadius:'0.25rem',marginBottom:'0.5rem'}}><strong>Soluci√≥n:</strong> {sol.solucion}</p>
                                            <button onClick={()=>aplicarSolucion(sol)} className="btn" style={{background:'#8b5cf6',color:'#fff',fontSize:'0.75rem',padding:'0.25rem 0.75rem'}}>üìã Usar como referencia</button>
                                        </div>)}
                                    </div>
                                </div>}
                                
                                {/* Repuestos recomendados */}
                                {robertAnalisis.repuestosRecomendados.length>0&&<div style={{marginBottom:'1rem'}}>
                                    <h4 style={{fontSize:'1rem',fontWeight:'700',color:'#6b21a8',marginBottom:'0.75rem',display:'flex',alignItems:'center',gap:'0.5rem'}}>
                                        üî© Repuestos M√°s Usados
                                    </h4>
                                    <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(200px,1fr))',gap:'0.75rem'}}>
                                        {robertAnalisis.repuestosRecomendados.map((rep,i)=>{
                                            const alerta=robertAnalisis.alertasInventario.find(a=>a.repuesto===rep.nombre);
                                            return(<div key={i} style={{background:'white',padding:'0.75rem',borderRadius:'0.5rem',border:'2px solid',borderColor:alerta?.tipo==='success'?'#10b981':alerta?.tipo==='warning'?'#f59e0b':'#ef4444'}}>
                                                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'0.5rem'}}>
                                                    <span style={{fontSize:'0.875rem',fontWeight:'700',color:'#111827'}}>{rep.nombre}</span>
                                                    <span style={{fontSize:'0.75rem',background:'#f3f4f6',padding:'0.25rem 0.5rem',borderRadius:'999px',fontWeight:'600'}}>√ó{rep.cantidad}</span>
                                                </div>
                                                {alerta&&<div style={{fontSize:'0.75rem',color:alerta.tipo==='success'?'#065f46':alerta.tipo==='warning'?'#92400e':'#991b1b',marginBottom:'0.5rem'}}>
                                                    {alerta.icono} {alerta.texto}
                                                </div>}
                                                <button onClick={()=>agregarRepuesto(rep.nombre)} className="btn" style={{background:'#10b981',color:'#fff',fontSize:'0.75rem',padding:'0.25rem 0.5rem',width:'100%'}}>+ Agregar</button>
                                            </div>);
                                        })}
                                    </div>
                                </div>}
                                
                                {robertAnalisis.otsSimilares===0&&<div style={{textAlign:'center',padding:'2rem',background:'rgba(255,255,255,0.7)',borderRadius:'0.5rem'}}>
                                    <p style={{fontSize:'1.25rem',marginBottom:'0.5rem'}}>üÜï</p>
                                    <p style={{color:'#6b21a8',fontWeight:'600'}}>Este es un problema nuevo</p>
                                    <p style={{fontSize:'0.875rem',color:'#7c3aed'}}>No hay casos similares en el historial. Robert aprender√° de esta OT para futuras consultas.</p>
                                </div>}
                            </>}
                        </>}
                    </div>}
                    
                    <div style={{display:'flex',gap:'0.5rem'}}><button onClick={save} className="btn bp" style={{flex:1}}>Guardar</button><button onClick={()=>setM(null)} className="btn bg" style={{flex:1}}>Cancelar</button></div>
                </div>
            </div>);
        }
        
        function CMod({m,setM,os,saveO,us}){
            const[f,setF]=useState({tr:'',re:'',obs:''});
            const close=()=>{
                if(!f.tr||!f.re)return alert('‚ö†Ô∏è Complete trabajos realizados y resultado');
                const updated={...m.d,es:'completada',fi:new Date().toISOString(),trab:f.tr,re:f.re,obsc:f.obs};
                saveO(os.map(x=>x.id===m.d.id?updated:x));
                
                // Enviar WhatsApp
                const sup=us.find(u=>u.role==='supervisor');
                const crea=us.find(u=>u.name===m.d.creadoPor);
                const msg=`‚úÖ *OT COMPLETADA*\n\nüìã *N¬∫:* ${m.d.n}\nüë§ *Mec√°nico:* ${m.d.aa}\nüìù *Trabajo:* ${m.d.tr}\n\nüîß *Trabajos realizados:*\n${f.tr}\n\nüìä *Resultado:* ${f.re==='ok'?'‚úÖ SOLUCIONADO':'‚ùå NO SOLUCIONADO'}${m.d.rp?.length>0?'\n\nüî© *Repuestos:*\n'+m.d.rp.map(r=>r.nom+' ('+r.cant+')').join('\n'):''}`;
                if(sup?.tel){const tel=sup.tel.replace(/\D/g,'');window.open(`https://wa.me/${tel}?text=${encodeURIComponent(msg)}`,'_blank')}
                
                // Enviar Email
                const mailto=`mailto:${sup?.email||''}?subject=OT ${m.d.n} Completada&body=${encodeURIComponent('ORDEN COMPLETADA\n\nN¬∫: '+m.d.n+'\nMec√°nico: '+m.d.aa+'\nTrabajo: '+m.d.tr+'\n\nTrabajos realizados:\n'+f.tr+'\n\nResultado: '+(f.re==='ok'?'SOLUCIONADO':'NO SOLUCIONADO'))}`;
                window.location.href=mailto;
                
                setM(null);
                alert('‚úÖ Orden cerrada correctamente');
            };
            return(<div style={{position:'fixed',inset:0,background:'rgba(0,0,0,0.5)',display:'flex',alignItems:'center',justifyContent:'center',padding:'1rem',zIndex:50}} onClick={()=>setM(null)}>
                <div style={{background:'#fff',borderRadius:'0.5rem',padding:'1.5rem',width:'100%',maxWidth:'600px',maxHeight:'90vh',overflowY:'auto'}} onClick={e=>e.stopPropagation()}>
                    <h2 style={{marginBottom:'1rem',fontSize:'1.5rem',fontWeight:'bold'}}>‚úÖ Cierre de OT</h2>
                    <div style={{background:'#dbeafe',padding:'1rem',borderRadius:'0.5rem',marginBottom:'1rem',borderLeft:'4px solid #2563eb'}}>
                        <p style={{fontWeight:'600',color:'#1e40af'}}>OT: {m.d.n}</p>
                        <p style={{fontSize:'0.875rem',color:'#1e40af'}}>Asignado: {m.d.aa}</p>
                        <p style={{fontSize:'0.875rem',color:'#1e40af'}}>Trabajo: {m.d.tr}</p>
                    </div>
                    
                    <label style={{display:'block',fontWeight:'600',marginBottom:'0.5rem'}}>Trabajos Realizados *</label>
                    <textarea placeholder="Describe detalladamente los trabajos realizados..." value={f.tr} onChange={e=>setF({...f,tr:e.target.value})} style={{minHeight:'100px',marginBottom:'1rem'}}/>
                    
                    <label style={{display:'block',fontWeight:'600',marginBottom:'0.5rem'}}>Repuestos Usados</label>
                    <div style={{padding:'0.75rem',background:'#f9fafb',borderRadius:'0.375rem',border:'1px solid #e5e7eb',marginBottom:'1rem'}}>
                        {m.d.rp?.length>0?m.d.rp.map((r,i)=><div key={i} style={{padding:'0.5rem',marginBottom:'0.25rem'}}>üî© {r.nom} - Cantidad: {r.cant}</div>):<p style={{margin:0,color:'#6b7280',fontSize:'0.875rem'}}>No se registraron repuestos</p>}
                    </div>
                    
                    <label style={{display:'block',fontWeight:'600',marginBottom:'0.5rem'}}>Resultado de los Trabajos *</label>
                    <div style={{display:'flex',gap:'1rem',marginBottom:'1rem'}}>
                        <label style={{flex:1,padding:'0.75rem',border:'2px solid',borderColor:f.re==='ok'?'#10b981':'#d1d5db',borderRadius:'0.375rem',cursor:'pointer',background:f.re==='ok'?'#d1fae5':'#fff',display:'flex',alignItems:'center',gap:'0.5rem'}}>
                            <input type="radio" name="re" value="ok" checked={f.re==='ok'} onChange={e=>setF({...f,re:e.target.value})} style={{width:'20px',height:'20px'}}/>
                            <span style={{fontWeight:'600',color:f.re==='ok'?'#065f46':'#374151'}}>‚úÖ Solucionado</span>
                        </label>
                        <label style={{flex:1,padding:'0.75rem',border:'2px solid',borderColor:f.re==='no'?'#ef4444':'#d1d5db',borderRadius:'0.375rem',cursor:'pointer',background:f.re==='no'?'#fee2e2':'#fff',display:'flex',alignItems:'center',gap:'0.5rem'}}>
                            <input type="radio" name="re" value="no" checked={f.re==='no'} onChange={e=>setF({...f,re:e.target.value})} style={{width:'20px',height:'20px'}}/>
                            <span style={{fontWeight:'600',color:f.re==='no'?'#991b1b':'#374151'}}>‚ùå No Solucionado</span>
                        </label>
                    </div>
                    
                    <label style={{display:'block',fontWeight:'600',marginBottom:'0.5rem'}}>Observaciones Adicionales</label>
                    <textarea placeholder="Cualquier observaci√≥n adicional..." value={f.obs} onChange={e=>setF({...f,obs:e.target.value})} style={{minHeight:'80px',marginBottom:'1.5rem'}}/>
                    
                    <div style={{display:'flex',gap:'0.5rem'}}>
                        <button onClick={close} className="btn bs" style={{flex:1,display:'flex',alignItems:'center',justifyContent:'center',gap:'0.5rem'}}>‚úÖ Confirmar Cierre</button>
                        <button onClick={()=>setM(null)} className="btn bg" style={{flex:1}}>Cancelar</button>
                    </div>
                </div>
            </div>);
        }
        
        function VMod({m,setM,us,os,saveO,hp}){
            const o=m.d;
            const currentUser=JSON.parse(localStorage.getItem('currentUser')||'{}');
            
            // Funci√≥n para generar PDF con formato GMP
            const generarPDF_GMP=()=>{
                const{jsPDF}=window.jspdf;
                const doc=new jsPDF();
                let y=20;
                
                // HEADER con logo y t√≠tulo
                doc.setFillColor(37,99,235);
                doc.rect(0,0,210,40,'F');
                doc.setTextColor(255,255,255);
                doc.setFontSize(24);
                doc.setFont(undefined,'bold');
                doc.text('ORDEN DE TRABAJO',105,20,'center');
                doc.setFontSize(14);
                doc.text(`N¬∫ ${o.n}`,105,30,'center');
                
                // Fecha de generaci√≥n
                doc.setFontSize(9);
                doc.text(`Generado: ${new Date().toLocaleString('es-ES')}`,15,37);
                
                y=50;
                doc.setTextColor(0,0,0);
                
                // SECCI√ìN: Estado y Tipo
                doc.setFillColor(243,244,246);
                doc.rect(10,y,190,15,'F');
                doc.setFontSize(10);
                doc.setFont(undefined,'bold');
                doc.text('INFORMACI√ìN GENERAL',15,y+10);
                y+=20;
                
                doc.setFontSize(9);
                doc.setFont(undefined,'normal');
                doc.text(`Tipo: ${o.ti.toUpperCase()}`,15,y);
                doc.text(`Estado: ${o.es.toUpperCase()}`,110,y);
                y+=10;
                
                // SECCI√ìN: Personal
                doc.setFillColor(243,244,246);
                doc.rect(10,y,190,15,'F');
                doc.setFont(undefined,'bold');
                doc.setFontSize(10);
                doc.text('PERSONAL ASIGNADO',15,y+10);
                y+=20;
                
                doc.setFont(undefined,'normal');
                doc.setFontSize(9);
                doc.text(`Asignado a: ${o.aa}`,15,y);
                doc.text(`Creado por: ${o.creadoPor||'N/A'}`,110,y);
                y+=15;
                
                // SECCI√ìN: Descripci√≥n del Trabajo
                doc.setFillColor(255,251,235);
                doc.rect(10,y,190,8,'F');
                doc.setFont(undefined,'bold');
                doc.setFontSize(10);
                doc.text('TRABAJO A REALIZAR',15,y+6);
                y+=12;
                
                doc.setFont(undefined,'normal');
                doc.setFontSize(9);
                const descLines=doc.splitTextToSize(o.tr,170);
                doc.text(descLines,15,y);
                y+=descLines.length*5+10;
                
                // SECCI√ìN: Trabajos Realizados
                if(o.trab){
                    doc.setFillColor(209,250,229);
                    doc.rect(10,y,190,8,'F');
                    doc.setFont(undefined,'bold');
                    doc.setFontSize(10);
                    doc.text('TRABAJOS REALIZADOS',15,y+6);
                    y+=12;
                    
                    doc.setFont(undefined,'normal');
                    doc.setFontSize(9);
                    const trabLines=doc.splitTextToSize(o.trab,170);
                    doc.text(trabLines,15,y);
                    y+=trabLines.length*5+10;
                }
                
                // SECCI√ìN: Fechas
                if(o.in||o.dl||o.fi){
                    doc.setFillColor(243,244,246);
                    doc.rect(10,y,190,8,'F');
                    doc.setFont(undefined,'bold');
                    doc.setFontSize(10);
                    doc.text('FECHAS',15,y+6);
                    y+=12;
                    
                    doc.setFont(undefined,'normal');
                    doc.setFontSize(9);
                    if(o.in){
                        doc.text(`Inicio: ${new Date(o.in).toLocaleString('es-ES')}`,15,y);
                        y+=6;
                    }
                    if(o.dl){
                        doc.text(`Deadline: ${new Date(o.dl).toLocaleString('es-ES')}`,15,y);
                        y+=6;
                    }
                    if(o.fi){
                        doc.text(`Fin: ${new Date(o.fi).toLocaleString('es-ES')}`,15,y);
                        y+=6;
                    }
                    y+=8;
                }
                
                // SECCI√ìN: Repuestos
                if(o.rp?.length>0){
                    if(y>250){doc.addPage();y=20;}
                    doc.setFillColor(243,244,246);
                    doc.rect(10,y,190,8,'F');
                    doc.setFont(undefined,'bold');
                    doc.setFontSize(10);
                    doc.text('REPUESTOS UTILIZADOS',15,y+6);
                    y+=12;
                    
                    // Tabla de repuestos
                    doc.setFontSize(8);
                    doc.setFont(undefined,'bold');
                    doc.text('REPUESTO',15,y);
                    doc.text('CANTIDAD',170,y);
                    y+=5;
                    doc.line(10,y,200,y);
                    y+=5;
                    
                    doc.setFont(undefined,'normal');
                    o.rp.forEach(r=>{
                        if(y>280){doc.addPage();y=20;}
                        doc.text(r.nom,15,y);
                        doc.text(String(r.cant),170,y);
                        y+=5;
                    });
                    y+=10;
                }
                
                // SECCI√ìN: Resultado
                if(o.re){
                    if(y>250){doc.addPage();y=20;}
                    doc.setFillColor(o.re==='ok'?209:254,o.re==='ok'?250:226,o.re==='ok'?229:226);
                    doc.rect(10,y,190,15,'F');
                    doc.setFont(undefined,'bold');
                    doc.setFontSize(12);
                    doc.setTextColor(o.re==='ok'?6:153,o.re==='ok'?95:27,o.re==='ok'?70:27);
                    doc.text(o.re==='ok'?'‚úì TRABAJO SOLUCIONADO':'‚úó TRABAJO NO SOLUCIONADO',105,y+10,'center');
                    doc.setTextColor(0,0,0);
                    y+=20;
                }
                
                // SECCI√ìN: Observaciones
                if(o.ob||o.obsc){
                    if(y>250){doc.addPage();y=20;}
                    doc.setFillColor(243,244,246);
                    doc.rect(10,y,190,8,'F');
                    doc.setFont(undefined,'bold');
                    doc.setFontSize(10);
                    doc.text('OBSERVACIONES',15,y+6);
                    y+=12;
                    
                    doc.setFont(undefined,'normal');
                    doc.setFontSize(9);
                    const obsLines=doc.splitTextToSize(o.obsc||o.ob,170);
                    doc.text(obsLines,15,y);
                    y+=obsLines.length*5+15;
                }
                
                // SECCI√ìN GMP: Firmas (solo si est√° cerrada)
                if(o.es==='cerrada'){
                    if(y>230){doc.addPage();y=20;}
                    doc.setFillColor(243,244,246);
                    doc.rect(10,y,190,8,'F');
                    doc.setFont(undefined,'bold');
                    doc.setFontSize(10);
                    doc.text('APROBACIONES Y FIRMAS - GMP',15,y+6);
                    y+=15;
                    
                    // L√≠neas de firma
                    doc.setFontSize(9);
                    doc.line(15,y+20,90,y+20);
                    doc.text('Realizado por:',15,y+25);
                    doc.text(o.aa,15,y+30);
                    
                    doc.line(110,y+20,185,y+20);
                    doc.text('Verificado por (Supervisor):',110,y+25);
                    doc.text(currentUser.name||'_________________',110,y+30);
                    
                    y+=40;
                    doc.text(`Fecha de cierre: ${o.fi?new Date(o.fi).toLocaleString('es-ES'):'N/A'}`,15,y);
                }
                
                // FOOTER con informaci√≥n de trazabilidad GMP
                const pageCount=doc.internal.getNumberOfPages();
                for(let i=1;i<=pageCount;i++){
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(128,128,128);
                    doc.text(`OT-${o.n} | P√°gina ${i} de ${pageCount}`,105,290,'center');
                    doc.text(`Sistema de Gesti√≥n de Mantenimiento - Cumplimiento GMP`,105,295,'center');
                }
                
                return doc;
            };
            
            // Descargar PDF
            const descargarPDF=()=>{
                const doc=generarPDF_GMP();
                doc.save(`OT-${o.n}_${new Date().toISOString().split('T')[0]}.pdf`);
            };
            
            // Imprimir PDF
            const imprimirPDF=()=>{
                const doc=generarPDF_GMP();
                const pdfBlob=doc.output('blob');
                const pdfUrl=URL.createObjectURL(pdfBlob);
                const printWindow=window.open(pdfUrl,'_blank');
                printWindow.onload=function(){
                    printWindow.print();
                };
            };
            
            const wa=()=>{
                const tel=us.find(u=>u.name===o.aa)?.tel;
                if(!tel)return alert('‚ö†Ô∏è Sin tel√©fono registrado');
                const telClean=tel.replace(/\D/g,'');
                const msg=`üîß *ORDEN DE TRABAJO*\n\nüìã *N¬∫:* ${o.n}\nüìä *Estado:* ${o.es}\nüë§ *Asignado:* ${o.aa}\nüìù *Trabajo:* ${o.tr}`;
                window.open(`https://wa.me/${telClean}?text=${encodeURIComponent(msg)}`,'_blank');
            };
            return(<div style={{position:'fixed',inset:0,background:'rgba(0,0,0,0.6)',display:'flex',alignItems:'center',justifyContent:'center',padding:'1rem',zIndex:50,backdropFilter:'blur(2px)'}} onClick={()=>setM(null)}>
                <div style={{background:'#fff',borderRadius:'0.75rem',padding:'0',width:'100%',maxWidth:'750px',maxHeight:'90vh',overflowY:'auto',boxShadow:'0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04)'}} onClick={e=>e.stopPropagation()}>
                    
                    {/* Header con degradado */}
                    <div style={{background:'linear-gradient(135deg,#2563eb,#1e40af)',color:'#fff',padding:'2rem',borderRadius:'0.75rem 0.75rem 0 0',position:'relative'}}>
                        <button onClick={()=>setM(null)} style={{position:'absolute',top:'1rem',right:'1rem',border:'none',background:'rgba(255,255,255,0.2)',color:'#fff',cursor:'pointer',fontSize:'1.5rem',width:'40px',height:'40px',borderRadius:'50%',display:'flex',alignItems:'center',justifyContent:'center',transition:'all 0.2s'}}>‚úñ</button>
                        <div style={{marginBottom:'1rem'}}>
                            <p style={{fontSize:'0.875rem',opacity:0.9,marginBottom:'0.25rem'}}>Orden de Trabajo</p>
                            <h2 style={{fontSize:'2.5rem',fontWeight:'bold',margin:0}}>{o.n}</h2>
                        </div>
                        <div style={{display:'flex',gap:'0.5rem',flexWrap:'wrap'}}>
                            <span style={{padding:'0.375rem 1rem',background:'rgba(255,255,255,0.25)',borderRadius:'999px',fontSize:'0.875rem',fontWeight:'600',backdropFilter:'blur(10px)'}}>{o.ti.toUpperCase()}</span>
                            <span style={{padding:'0.375rem 1rem',background:o.es==='creada'?'#f59e0b':o.es==='haciendo'?'#3b82f6':o.es==='hecha'?'#10b981':o.es==='registrada'?'#a855f7':'#6b7280',borderRadius:'999px',fontSize:'0.875rem',fontWeight:'600',boxShadow:'0 2px 4px rgba(0,0,0,0.1)'}}>{o.es.toUpperCase()}</span>
                        </div>
                    </div>
                    
                    {/* Contenido */}
                    <div style={{padding:'2rem'}}>
                    
                        {/* üë• Informaci√≥n de Personal */}
                        <div style={{marginBottom:'1.5rem'}}>
                            <h3 style={{fontSize:'0.875rem',fontWeight:'700',color:'#6b7280',marginBottom:'1rem',textTransform:'uppercase',letterSpacing:'0.05em'}}>üë• Personal</h3>
                            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'1rem'}}>
                                <div style={{background:'linear-gradient(135deg,#f9fafb,#ffffff)',padding:'1.25rem',borderRadius:'0.5rem',border:'2px solid #e5e7eb',boxShadow:'0 1px 3px rgba(0,0,0,0.05)'}}>
                                    <p style={{fontSize:'0.75rem',color:'#6b7280',marginBottom:'0.5rem',textTransform:'uppercase',fontWeight:'600',letterSpacing:'0.05em'}}>Asignado a</p>
                                    <p style={{fontSize:'1.125rem',fontWeight:'700',color:'#111827',display:'flex',alignItems:'center',gap:'0.5rem'}}>üë§ {o.aa}</p>
                                </div>
                                <div style={{background:'linear-gradient(135deg,#f9fafb,#ffffff)',padding:'1.25rem',borderRadius:'0.5rem',border:'2px solid #e5e7eb',boxShadow:'0 1px 3px rgba(0,0,0,0.05)'}}>
                                    <p style={{fontSize:'0.75rem',color:'#6b7280',marginBottom:'0.5rem',textTransform:'uppercase',fontWeight:'600',letterSpacing:'0.05em'}}>Creado por</p>
                                    <p style={{fontSize:'1.125rem',fontWeight:'700',color:'#111827',display:'flex',alignItems:'center',gap:'0.5rem'}}>üë®‚Äçüíº {o.creadoPor||'N/A'}</p>
                                </div>
                            </div>
                        </div>
                        
                        {/* üìù Descripci√≥n del Trabajo */}
                        <div style={{marginBottom:'1.5rem'}}>
                            <h3 style={{fontSize:'0.875rem',fontWeight:'700',color:'#6b7280',marginBottom:'1rem',textTransform:'uppercase',letterSpacing:'0.05em'}}>üìù Descripci√≥n</h3>
                            <div style={{background:'#fffbeb',padding:'1.25rem',borderRadius:'0.5rem',border:'2px solid #fbbf24',boxShadow:'0 1px 3px rgba(251,191,36,0.1)'}}>
                                <p style={{fontSize:'0.875rem',fontWeight:'700',color:'#92400e',marginBottom:'0.75rem',display:'flex',alignItems:'center',gap:'0.5rem'}}>
                                    <span style={{background:'#fbbf24',color:'#fff',padding:'0.25rem 0.5rem',borderRadius:'0.25rem',fontSize:'0.75rem'}}>TRABAJO A REALIZAR</span>
                                </p>
                                <p style={{color:'#78350f',lineHeight:'1.7',fontSize:'0.95rem'}}>{o.tr}</p>
                            </div>
                        </div>
                        
                        {/* ‚úÖ Trabajos Realizados */}
                        {o.trab&&<div style={{marginBottom:'1.5rem'}}>
                            <div style={{background:'#d1fae5',padding:'1.25rem',borderRadius:'0.5rem',border:'2px solid #10b981',boxShadow:'0 1px 3px rgba(16,185,129,0.1)'}}>
                                <p style={{fontSize:'0.875rem',fontWeight:'700',color:'#065f46',marginBottom:'0.75rem',display:'flex',alignItems:'center',gap:'0.5rem'}}>
                                    <span style={{background:'#10b981',color:'#fff',padding:'0.25rem 0.5rem',borderRadius:'0.25rem',fontSize:'0.75rem'}}>TRABAJOS REALIZADOS</span>
                                </p>
                                <p style={{color:'#064e3b',lineHeight:'1.7',fontSize:'0.95rem'}}>{o.trab}</p>
                            </div>
                        </div>}
                        
                        {/* üìÖ Fechas */}
                        {(o.in||o.dl||o.fi)&&<div style={{marginBottom:'1.5rem'}}>
                            <h3 style={{fontSize:'0.875rem',fontWeight:'700',color:'#6b7280',marginBottom:'1rem',textTransform:'uppercase',letterSpacing:'0.05em'}}>üìÖ Fechas</h3>
                            <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(200px,1fr))',gap:'1rem'}}>
                                {o.in&&<div style={{background:'#f9fafb',padding:'1rem',borderRadius:'0.5rem',border:'1px solid #e5e7eb'}}>
                                    <p style={{fontSize:'0.75rem',color:'#6b7280',marginBottom:'0.5rem',fontWeight:'600',display:'flex',alignItems:'center',gap:'0.25rem'}}>üìÖ Fecha Inicio</p>
                                    <p style={{fontSize:'0.95rem',fontWeight:'600',color:'#111827'}}>{new Date(o.in).toLocaleString('es-ES')}</p>
                                </div>}
                                {o.dl&&<div style={{background:'#fef3c7',padding:'1rem',borderRadius:'0.5rem',border:'1px solid #fbbf24'}}>
                                    <p style={{fontSize:'0.75rem',color:'#92400e',marginBottom:'0.5rem',fontWeight:'600',display:'flex',alignItems:'center',gap:'0.25rem'}}>‚è∞ Deadline</p>
                                    <p style={{fontSize:'0.95rem',fontWeight:'600',color:'#78350f'}}>{new Date(o.dl).toLocaleString('es-ES')}</p>
                                </div>}
                                {o.fi&&<div style={{background:'#d1fae5',padding:'1rem',borderRadius:'0.5rem',border:'1px solid #10b981'}}>
                                    <p style={{fontSize:'0.75rem',color:'#065f46',marginBottom:'0.5rem',fontWeight:'600',display:'flex',alignItems:'center',gap:'0.25rem'}}>‚úÖ Fecha Fin</p>
                                    <p style={{fontSize:'0.95rem',fontWeight:'600',color:'#064e3b'}}>{new Date(o.fi).toLocaleString('es-ES')}</p>
                                </div>}
                            </div>
                        </div>}
                        
                        {/* üî© Repuestos */}
                        {o.rp?.length>0&&<div style={{marginBottom:'1.5rem'}}>
                            <h3 style={{fontSize:'0.875rem',fontWeight:'700',color:'#6b7280',marginBottom:'1rem',textTransform:'uppercase',letterSpacing:'0.05em'}}>üî© Repuestos Usados</h3>
                            <div style={{background:'#f9fafb',padding:'0.5rem',borderRadius:'0.5rem',border:'1px solid #e5e7eb'}}>
                                {o.rp.map((r,i)=><div key={i} style={{padding:'0.75rem 1rem',borderBottom:i<o.rp.length-1?'1px solid #e5e7eb':'none',background:i%2===0?'#fff':'transparent',borderRadius:'0.25rem',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                                    <span style={{fontWeight:'600',color:'#111827',fontSize:'0.95rem'}}>{r.nom}</span>
                                    <span style={{color:'#6b7280',fontSize:'0.875rem',background:'#e5e7eb',padding:'0.25rem 0.75rem',borderRadius:'999px',fontWeight:'600'}}>Cant: {r.cant}</span>
                                </div>)}
                            </div>
                        </div>}
                        
                        {/* üìä Resultado */}
                        {o.re&&<div style={{marginBottom:'1.5rem'}}>
                            <h3 style={{fontSize:'0.875rem',fontWeight:'700',color:'#6b7280',marginBottom:'1rem',textTransform:'uppercase',letterSpacing:'0.05em'}}>üìä Resultado Final</h3>
                            <div style={{padding:'1.5rem',borderRadius:'0.5rem',background:o.re==='ok'?'linear-gradient(135deg,#d1fae5,#a7f3d0)':'linear-gradient(135deg,#fee2e2,#fecaca)',border:'3px solid',borderColor:o.re==='ok'?'#10b981':'#ef4444',boxShadow:o.re==='ok'?'0 4px 6px rgba(16,185,129,0.2)':'0 4px 6px rgba(239,68,68,0.2)',textAlign:'center'}}>
                                <p style={{fontSize:'1.5rem',fontWeight:'700',color:o.re==='ok'?'#065f46':'#991b1b',display:'flex',alignItems:'center',justifyContent:'center',gap:'0.75rem'}}>
                                    {o.re==='ok'?'‚úÖ SOLUCIONADO':'‚ùå NO SOLUCIONADO'}
                                </p>
                            </div>
                        </div>}
                        
                        {/* üìù Observaciones */}
                        {(o.ob||o.obsc)&&<div style={{marginBottom:'1.5rem'}}>
                            <h3 style={{fontSize:'0.875rem',fontWeight:'700',color:'#6b7280',marginBottom:'1rem',textTransform:'uppercase',letterSpacing:'0.05em'}}>üìù Observaciones</h3>
                            <div style={{background:'#f9fafb',padding:'1.25rem',borderRadius:'0.5rem',border:'1px solid #e5e7eb',boxShadow:'inset 0 1px 2px rgba(0,0,0,0.05)'}}>
                                <p style={{color:'#374151',lineHeight:'1.7',fontSize:'0.95rem',fontStyle:'italic'}}>{o.obsc||o.ob}</p>
                            </div>
                        </div>}
                        
                        {/* üé¨ Acciones */}
                        <div style={{display:'flex',gap:'0.75rem',marginTop:'2rem',paddingTop:'1.5rem',borderTop:'2px solid #e5e7eb',flexWrap:'wrap'}}>
                            <button onClick={()=>setM({t:'prog',d:o})} className="btn bp" style={{flex:1,padding:'0.875rem',fontSize:'1rem',display:'flex',alignItems:'center',justifyContent:'center',gap:'0.5rem',boxShadow:'0 2px 4px rgba(37,99,235,0.2)'}}>üìù Ver/Editar Progreso</button>
                            <button onClick={wa} className="btn bs" style={{flex:1,padding:'0.875rem',fontSize:'1rem',display:'flex',alignItems:'center',justifyContent:'center',gap:'0.5rem',boxShadow:'0 2px 4px rgba(16,185,129,0.2)'}}>üì± Enviar WhatsApp</button>
                            
                            {/* Botones PDF - Siempre visibles pero con validaci√≥n */}
                            <button 
                                onClick={()=>{
                                    if(!hp('pdf')){
                                        alert('‚ö†Ô∏è No tienes permiso para generar PDFs');
                                        return;
                                    }
                                    if(o.es!=='cerrada'){
                                        alert('‚ö†Ô∏è Solo se puede generar PDF de OTs CERRADAS.\n\nEstado actual: '+o.es.toUpperCase());
                                        return;
                                    }
                                    descargarPDF();
                                }} 
                                className="btn" 
                                style={{
                                    flex:1,
                                    padding:'0.875rem',
                                    fontSize:'1rem',
                                    display:'flex',
                                    alignItems:'center',
                                    justifyContent:'center',
                                    gap:'0.5rem',
                                    background:hp('pdf')&&o.es==='cerrada'?'#dc2626':'#9ca3af',
                                    color:'#fff',
                                    boxShadow:'0 2px 4px rgba(220,38,38,0.2)',
                                    cursor:hp('pdf')&&o.es==='cerrada'?'pointer':'not-allowed',
                                    opacity:hp('pdf')&&o.es==='cerrada'?1:0.6
                                }}>
                                üìÑ Descargar PDF
                            </button>
                            
                            <button 
                                onClick={()=>{
                                    if(!hp('imp')){
                                        alert('‚ö†Ô∏è No tienes permiso para imprimir PDFs');
                                        return;
                                    }
                                    if(o.es!=='cerrada'){
                                        alert('‚ö†Ô∏è Solo se puede imprimir OTs CERRADAS.\n\nEstado actual: '+o.es.toUpperCase());
                                        return;
                                    }
                                    imprimirPDF();
                                }} 
                                className="btn" 
                                style={{
                                    flex:1,
                                    padding:'0.875rem',
                                    fontSize:'1rem',
                                    display:'flex',
                                    alignItems:'center',
                                    justifyContent:'center',
                                    gap:'0.5rem',
                                    background:hp('imp')&&o.es==='cerrada'?'#7c3aed':'#9ca3af',
                                    color:'#fff',
                                    boxShadow:'0 2px 4px rgba(124,58,237,0.2)',
                                    cursor:hp('imp')&&o.es==='cerrada'?'pointer':'not-allowed',
                                    opacity:hp('imp')&&o.es==='cerrada'?1:0.6
                                }}>
                                üñ®Ô∏è Imprimir
                            </button>
                            
                            <button onClick={()=>setM(null)} className="btn bg" style={{flex:1,padding:'0.875rem',fontSize:'1rem'}}>Cerrar</button>
                        </div>
                        
                        {/* Indicador de estado para PDF */}
                        <div style={{marginTop:'1rem',padding:'0.75rem',background:'#f3f4f6',borderRadius:'0.5rem',fontSize:'0.875rem',color:'#6b7280'}}>
                            <strong>Info:</strong> Los botones de PDF est√°n {hp('pdf')&&hp('imp')&&o.es==='cerrada'?'‚úÖ ACTIVOS':'‚ö†Ô∏è DESACTIVADOS'}
                            {!hp('pdf')&&' (requiere permiso PDF)'}
                            {!hp('imp')&&' (requiere permiso Impresi√≥n)'}
                            {o.es!=='cerrada'&&' (requiere OT Cerrada)'}
                        </div>
                    </div>
                </div>
            </div>);
        }
        
        function ProgMod({m,setM,os,saveO,inv,u}){
            const o=m.d;
            const[nuevoProg,setNuevoProg]=useState({desc:'',usuario:''});
            const[editando,setEditando]=useState(null);
            const[showRepSel,setShowRepSel]=useState(false);
            const[repuestosTemp,setRepuestosTemp]=useState(o.rp||[]);
            
            const getNextEstado=()=>{
                if(o.es==='creada')return 'haciendo';
                if(o.es==='haciendo')return 'hecha';
                if(o.es==='hecha')return u.role==='supervisor'?'registrada':null;
                if(o.es==='registrada'&&u.role==='supervisor')return 'cerrada';
                return null;
            };
            
            const cambiarEstado=()=>{
                const next=getNextEstado();
                if(!next)return alert('No puedes cambiar el estado');
                const actualizado={...o,es:next,fi:next==='cerrada'?new Date().toISOString():o.fi};
                // Pasar orden anterior para descuento de repuestos
                saveO(os.map(x=>x.id===o.id?actualizado:x),o);
                setM({...m,d:actualizado});
            };
            
            const getEstadoBadge=()=>{
                const badges={
                    'creada':{bg:'#fef3c7',color:'#92400e',icon:'üìã',text:'Creada'},
                    'haciendo':{bg:'#dbeafe',color:'#1e40af',icon:'üîß',text:'Haciendo'},
                    'hecha':{bg:'#d1fae5',color:'#065f46',icon:'‚úÖ',text:'Hecha'},
                    'registrada':{bg:'#e9d5ff',color:'#6b21a8',icon:'üìù',text:'Registrada'},
                    'cerrada':{bg:'#e5e7eb',color:'#374151',icon:'üîí',text:'Cerrada'}
                };
                return badges[o.es]||badges['creada'];
            };
            
            const getBadgeNext=()=>{
                const next=getNextEstado();
                const badges={
                    'haciendo':{icon:'üîß',text:'Iniciar Trabajo'},
                    'hecha':{icon:'‚úÖ',text:'Marcar Hecha'},
                    'registrada':{icon:'üìù',text:'Registrar'},
                    'cerrada':{icon:'üîí',text:'Cerrar OT'}
                };
                return next?badges[next]:null;
            };
            
            const agregarProgreso=()=>{
                if(!nuevoProg.desc.trim())return alert('Escribe una descripci√≥n del trabajo');
                const progreso=o.progreso||[];
                const nuevo={
                    id:Date.now(),
                    desc:nuevoProg.desc,
                    fecha:new Date().toISOString(),
                    usuario:nuevoProg.usuario||'Usuario'
                };
                const actualizado={...o,progreso:[...progreso,nuevo],rp:repuestosTemp};
                saveO(os.map(x=>x.id===o.id?actualizado:x));
                setNuevoProg({desc:'',usuario:''});
                setM({...m,d:actualizado});
            };
            
            const agregarRepuesto=(item)=>{
                const cant=prompt(`Cantidad de "${item.nombre}" usada:`);
                if(cant){
                    setRepuestosTemp([...repuestosTemp,{id:Date.now(),nom:item.nombre,cant:parseInt(cant)||1,codigo:item.codigo}]);
                    setShowRepSel(false);
                }
            };
            
            const eliminarRepuesto=(id)=>{
                setRepuestosTemp(repuestosTemp.filter(r=>r.id!==id));
            };
            
            const editarProgreso=(id)=>{
                const progreso=o.progreso||[];
                const item=progreso.find(p=>p.id===id);
                if(!item)return;
                const nuevaDesc=prompt('Editar descripci√≥n:',item.desc);
                if(nuevaDesc===null)return;
                const actualizado={...o,progreso:progreso.map(p=>p.id===id?{...p,desc:nuevaDesc}:p)};
                saveO(os.map(x=>x.id===o.id?actualizado:x));
                setM({...m,d:actualizado});
            };
            
            const eliminarProgreso=(id)=>{
                if(!confirm('¬øEliminar esta actualizaci√≥n?'))return;
                const progreso=o.progreso||[];
                const actualizado={...o,progreso:progreso.filter(p=>p.id!==id)};
                saveO(os.map(x=>x.id===o.id?actualizado:x));
                setM({...m,d:actualizado});
            };
            
            const progreso=o.progreso||[];
            
            return(<div style={{position:'fixed',inset:0,background:'rgba(0,0,0,0.6)',display:'flex',alignItems:'center',justifyContent:'center',padding:'1rem',zIndex:60,backdropFilter:'blur(2px)'}} onClick={()=>setM({t:'v',d:o})}>
                <div style={{background:'#fff',borderRadius:'0.75rem',padding:'0',width:'100%',maxWidth:'700px',maxHeight:'90vh',display:'flex',flexDirection:'column',boxShadow:'0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04)'}} onClick={e=>e.stopPropagation()}>
                    
                    {/* Header */}
                    <div style={{background:'linear-gradient(135deg,#6366f1,#4f46e5)',color:'#fff',padding:'1.5rem',borderRadius:'0.75rem 0.75rem 0 0'}}>
                        <div style={{display:'flex',justifyContent:'space-between',alignItems:'start',marginBottom:'0.75rem'}}>
                            <div>
                                <h2 style={{fontSize:'1.5rem',fontWeight:'bold',margin:0,marginBottom:'0.5rem'}}>üìù Seguimiento de Progreso</h2>
                                <p style={{fontSize:'0.875rem',opacity:0.9}}>OT: {o.n} - {o.tr?.substring(0,50)}...</p>
                            </div>
                            {(()=>{
                                const badge=getEstadoBadge();
                                return(<div style={{background:badge.bg,color:badge.color,padding:'0.5rem 1rem',borderRadius:'999px',fontSize:'0.875rem',fontWeight:'700',boxShadow:'0 2px 8px rgba(0,0,0,0.15)'}}>{badge.icon} {badge.text}</div>);
                            })()}
                        </div>
                        {getNextEstado()&&(()=>{
                            const next=getBadgeNext();
                            return(<button onClick={cambiarEstado} style={{background:'rgba(255,255,255,0.25)',border:'2px solid rgba(255,255,255,0.5)',color:'#fff',padding:'0.5rem 1rem',borderRadius:'0.5rem',cursor:'pointer',fontSize:'0.875rem',fontWeight:'700',width:'100%',backdropFilter:'blur(10px)',transition:'all 0.2s'}} onMouseEnter={e=>e.target.style.background='rgba(255,255,255,0.35)'} onMouseLeave={e=>e.target.style.background='rgba(255,255,255,0.25)'}>{next.icon} {next.text}</button>);
                        })()}
                    </div>
                    
                    {/* Contenido scrolleable */}
                    <div style={{flex:1,overflowY:'auto',padding:'1.5rem'}}>
                        
                        {/* Formulario agregar */}
                        <div style={{background:'#f9fafb',padding:'1.5rem',borderRadius:'0.75rem',marginBottom:'1.5rem',border:'2px solid #e5e7eb'}}>
                            <h3 style={{fontSize:'1rem',fontWeight:'700',marginBottom:'1rem',color:'#111827'}}>‚ûï Agregar Actualizaci√≥n</h3>
                            <textarea 
                                placeholder="¬øQu√© se est√° haciendo? Ej: Se cambi√≥ el filtro de aceite, se comprob√≥ presi√≥n..."
                                value={nuevoProg.desc}
                                onChange={e=>setNuevoProg({...nuevoProg,desc:e.target.value})}
                                style={{width:'100%',minHeight:'100px',padding:'0.75rem',border:'1px solid #d1d5db',borderRadius:'0.5rem',fontSize:'0.875rem',marginBottom:'0.75rem',fontFamily:'inherit',resize:'vertical'}}
                            />
                            
                            {/* Secci√≥n de repuestos */}
                            <div style={{marginBottom:'1rem',padding:'1rem',background:'#fff',borderRadius:'0.5rem',border:'1px solid #e5e7eb'}}>
                                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'0.75rem'}}>
                                    <label style={{fontSize:'0.875rem',fontWeight:'600',color:'#374151'}}>üî© Repuestos Usados</label>
                                    <button onClick={()=>setShowRepSel(!showRepSel)} style={{background:'#2563eb',color:'#fff',border:'none',borderRadius:'0.375rem',padding:'0.375rem 0.75rem',cursor:'pointer',fontSize:'0.75rem',fontWeight:'600'}}>
                                        {showRepSel?'‚ùå Cerrar':'üì¶ Seleccionar'}
                                    </button>
                                </div>
                                
                                {repuestosTemp.length>0&&<div style={{marginBottom:'0.75rem'}}>
                                    {repuestosTemp.map(r=><div key={r.id} style={{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'0.5rem',background:'#f3f4f6',borderRadius:'0.375rem',marginBottom:'0.25rem',fontSize:'0.875rem'}}>
                                        <span>üî© {r.nom} ({r.codigo}) - {r.cant}u</span>
                                        <button onClick={()=>eliminarRepuesto(r.id)} style={{border:'none',background:'none',cursor:'pointer',color:'#ef4444',fontSize:'1rem'}}>üóëÔ∏è</button>
                                    </div>)}
                                </div>}
                                
                                {showRepSel&&<div style={{maxHeight:'200px',overflowY:'auto',border:'1px solid #e5e7eb',borderRadius:'0.375rem',background:'#fff'}}>
                                    <table style={{width:'100%',fontSize:'0.875rem'}}>
                                        <thead style={{position:'sticky',top:0,background:'#f9fafb'}}>
                                            <tr><th style={{padding:'0.5rem',fontSize:'0.75rem'}}>C√≥digo</th><th style={{padding:'0.5rem',fontSize:'0.75rem'}}>Nombre</th><th style={{padding:'0.5rem',textAlign:'center',fontSize:'0.75rem'}}>Stock</th><th style={{padding:'0.5rem',fontSize:'0.75rem'}}></th></tr>
                                        </thead>
                                        <tbody>
                                            {inv?.map(item=><tr key={item.id} style={{borderBottom:'1px solid #f3f4f6'}}>
                                                <td style={{padding:'0.5rem',fontFamily:'monospace',fontSize:'0.75rem'}}>{item.codigo}</td>
                                                <td style={{padding:'0.5rem',fontSize:'0.875rem'}}>{item.nombre}</td>
                                                <td style={{padding:'0.5rem',textAlign:'center',fontWeight:'600'}}>{item.cantidad}</td>
                                                <td style={{padding:'0.5rem'}}>
                                                    <button onClick={()=>agregarRepuesto(item)} style={{background:'#10b981',color:'#fff',border:'none',borderRadius:'0.25rem',padding:'0.25rem 0.5rem',cursor:'pointer',fontSize:'0.75rem'}}>+</button>
                                                </td>
                                            </tr>)}
                                        </tbody>
                                    </table>
                                </div>}
                                
                                {repuestosTemp.length===0&&!showRepSel&&<p style={{fontSize:'0.75rem',color:'#9ca3af',textAlign:'center',fontStyle:'italic'}}>No se agregaron repuestos</p>}
                            </div>
                            
                            <div style={{display:'flex',gap:'0.5rem'}}>
                                <button onClick={agregarProgreso} className="btn bp" style={{flex:1}}>‚úÖ Agregar Actualizaci√≥n</button>
                            </div>
                        </div>
                        
                        {/* Timeline de progreso */}
                        <div>
                            <h3 style={{fontSize:'1rem',fontWeight:'700',marginBottom:'1rem',color:'#111827'}}>üìã Historial de Trabajos ({progreso.length})</h3>
                            {progreso.length===0?
                                <div style={{textAlign:'center',padding:'3rem',color:'#9ca3af'}}>
                                    <div style={{fontSize:'3rem',marginBottom:'0.5rem'}}>üìù</div>
                                    <p>A√∫n no hay actualizaciones de progreso</p>
                                    <p style={{fontSize:'0.875rem'}}>Agrega la primera actualizaci√≥n arriba</p>
                                </div>
                            :
                                <div style={{position:'relative',paddingLeft:'2rem'}}>
                                    {/* L√≠nea temporal */}
                                    <div style={{position:'absolute',left:'0.5rem',top:'0',bottom:'0',width:'2px',background:'linear-gradient(180deg,#3b82f6,#10b981)'}}></div>
                                    
                                    {progreso.map((p,i)=><div key={p.id} style={{position:'relative',marginBottom:'1.5rem',animation:`slideIn 0.3s ease ${i*0.1}s both`}}>
                                        {/* Punto en timeline */}
                                        <div style={{position:'absolute',left:'-1.75rem',top:'0.25rem',width:'14px',height:'14px',background:'linear-gradient(135deg,#3b82f6,#2563eb)',borderRadius:'50%',border:'3px solid #fff',boxShadow:'0 0 0 2px #3b82f6'}}></div>
                                        
                                        {/* Card de actualizaci√≥n */}
                                        <div style={{background:'#fff',border:'2px solid #e5e7eb',borderRadius:'0.75rem',padding:'1.25rem',boxShadow:'0 2px 4px rgba(0,0,0,0.05)',transition:'all 0.2s'}} onMouseEnter={e=>e.currentTarget.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)'} onMouseLeave={e=>e.currentTarget.style.boxShadow='0 2px 4px rgba(0,0,0,0.05)'}>
                                            <div style={{display:'flex',justifyContent:'space-between',alignItems:'start',marginBottom:'0.75rem'}}>
                                                <div>
                                                    <p style={{fontSize:'0.75rem',color:'#6b7280',marginBottom:'0.25rem'}}>
                                                        üìÖ {new Date(p.fecha).toLocaleDateString('es-ES',{day:'2-digit',month:'2-digit',year:'numeric'})}
                                                        {' '}
                                                        ‚è∞ {new Date(p.fecha).toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'})}
                                                    </p>
                                                    {p.usuario&&<p style={{fontSize:'0.75rem',color:'#6b7280'}}>üë§ {p.usuario}</p>}
                                                </div>
                                                <div style={{display:'flex',gap:'0.25rem'}}>
                                                    <button onClick={()=>editarProgreso(p.id)} style={{border:'none',background:'#dbeafe',color:'#2563eb',cursor:'pointer',padding:'0.25rem 0.5rem',borderRadius:'0.25rem',fontSize:'0.875rem'}}>‚úèÔ∏è</button>
                                                    <button onClick={()=>eliminarProgreso(p.id)} style={{border:'none',background:'#fee2e2',color:'#ef4444',cursor:'pointer',padding:'0.25rem 0.5rem',borderRadius:'0.25rem',fontSize:'0.875rem'}}>üóëÔ∏è</button>
                                                </div>
                                            </div>
                                            <p style={{color:'#374151',lineHeight:'1.6',fontSize:'0.9375rem',whiteSpace:'pre-wrap'}}>{p.desc}</p>
                                        </div>
                                    </div>)}
                                </div>
                            }
                        </div>
                    </div>
                    
                    {/* Footer */}
                    <div style={{padding:'1rem 1.5rem',borderTop:'2px solid #e5e7eb',background:'#f9fafb',borderRadius:'0 0 0.75rem 0.75rem'}}>
                        <button onClick={()=>setM({t:'v',d:o})} className="btn bg" style={{width:'100%'}}>‚¨ÖÔ∏è Volver a Detalles</button>
                    </div>
                </div>
            </div>);
        }
        
        ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
    </script>
</body>
</html>